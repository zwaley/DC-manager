# 设备生命周期管理设计分析报告

## 1. 当前设计逻辑梳理

### 1.1 数据库设计

#### 设备表 (Device)
- `model` 字段：存储具体的设备型号，如 'DPFG-212-48/500'、'DPS6000-48/100' 等
- 这些是厂家的具体产品型号，非常详细和具体

#### 生命周期规则表 (LifecycleRule)
- `device_model` 字段：存储规则适用的设备型号
- 设计为与设备表的 `model` 字段进行**严格匹配**
- 当前规则中混合了两种类型的标识：
  - 设备类型：如 "整流器"、"ups"、"蓄电池"
  - 具体型号：如 "DPFG-212-48/500\t"

### 1.2 匹配逻辑

当前的匹配逻辑在 `main.py` 中：
```python
if device.model and device.model in rules_dict:
    rule = rules_dict[device.model]
```

这是**严格的字符串匹配**，要求设备的 `model` 字段与规则的 `device_model` 字段完全一致。

## 2. 发现的问题

### 2.1 设计逻辑不一致

**问题描述：**
- 数据库中有 26 种不同的具体设备型号（如 'DPFG-212-48/500'、'DPS6000-48/100'）
- 但生命周期规则中主要使用设备类型（如 "整流器"、"ups"）
- 这导致大部分设备无法匹配到对应的生命周期规则

**具体数据对比：**

设备表中的型号示例：
- 'DPFG-212-48/500'
- 'DPS6000-48/100'
- 'GFM-1500H'
- 'HyperCoolDX60'
- 'SCB10-1000/10'

规则表中的型号：
- '整流器' (8年)
- 'ups' (1年)
- '蓄电池' (3年)
- 'DPFG-212-48/500\t' (1年) ← 注意有制表符

### 2.2 数据质量问题

1. **制表符问题：** 规则 'DPFG-212-48/500\t' 末尾有制表符，导致无法与设备型号 'DPFG-212-48/500' 匹配
2. **大小写问题：** 规则中有 'ups'（小写），但实际设备型号可能是其他格式

### 2.3 用户界面提示不准确

在生命周期管理页面的表单提示中写着：
```html
<div class="form-text">请输入设备型号，如：整流器、UPS、空调等</div>
```

这个提示暗示用户应该输入设备类型，但实际的匹配逻辑是基于具体型号的严格匹配。

## 3. 设计方案分析

### 3.1 当前方案的问题

**优点：**
- 实现简单，直接字符串匹配
- 可以为特定型号设置精确的生命周期规则

**缺点：**
- 需要为每个具体型号单独创建规则，工作量巨大
- 新增设备型号时容易遗漏规则配置
- 用户体验差，需要输入复杂的具体型号
- 维护困难，型号变更时需要同步更新规则

### 3.2 建议的改进方案

#### 方案一：设备分类映射（推荐）

1. **增加设备分类字段**
   - 在设备表中增加 `device_category` 字段
   - 存储设备类型，如："整流器"、"UPS"、"蓄电池"、"空调"等

2. **修改规则匹配逻辑**
   - 规则基于设备分类进行匹配
   - 保持用户界面的简洁性

3. **数据迁移策略**
   - 根据设备型号的特征自动推断设备分类
   - 提供手动调整接口

#### 方案二：模糊匹配规则

1. **支持正则表达式或通配符**
   - 规则可以使用模式匹配，如 "DPFG-*" 匹配所有 DPFG 系列
   - 支持多个匹配模式

2. **优先级机制**
   - 精确匹配优先于模糊匹配
   - 支持规则优先级设置

#### 方案三：混合方案

1. **同时支持分类和具体型号**
   - 优先匹配具体型号规则
   - 如果没有具体型号规则，则使用分类规则

## 4. 当前问题的临时解决方案

### 4.1 数据清理

1. **清理制表符问题**
   ```sql
   UPDATE lifecycle_rules SET device_model = TRIM(device_model);
   ```

2. **统一大小写**
   - 将 'ups' 改为 'UPS'

### 4.2 快速修复建议

1. **为主要设备型号创建规则**
   - 为数据库中的主要设备型号（如 DPFG-212-48/500、DPS6000-48/100）创建具体规则
   - 或者修改现有规则，使用设备分类

2. **修改用户界面提示**
   - 明确说明应该输入具体的设备型号
   - 或者提供设备型号的下拉选择

## 5. 建议的实施步骤

1. **立即修复数据质量问题**（清理制表符、统一格式）
2. **确定长期设计方案**（建议采用方案一：设备分类映射）
3. **实施数据迁移**
4. **更新匹配逻辑**
5. **更新用户界面**
6. **测试验证**

## 6. 结论

当前生命周期管理功能的核心问题是**设计逻辑不一致**：
- 数据库存储的是具体设备型号
- 规则配置使用的是设备类型
- 匹配逻辑要求严格一致

这导致大部分设备无法匹配到生命周期规则，功能基本无法正常使用。需要重新设计匹配逻辑或调整数据结构来解决这个根本性问题。