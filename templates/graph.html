<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拓扑图 - DC Asset Manager</title>
    <!-- 引入Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入vis.js网络图库的CSS -->
    <link href="https://visjs.github.io/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style>
        /* 定义拓扑图容器的样式 */
        #mynetwork {
            width: 100%;
            height: 80vh; /* 高度为视口高度的80% */
            border: 1px solid lightgray;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- 页面导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">安吉电信动力设备管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/graph">拓扑图</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h1>设备电力链路拓扑图</h1>
                <p>请从下方选择一个设备以查看其相关的电力链路。图中将展示该设备的直接上游和下游设备。</p>
                <div class="mb-3">
                    <label for="device-select" class="form-label"><strong>选择设备:</strong></label>
                    <!-- 设备选择下拉框，选项由后端模板引擎动态生成 -->
                    <select class="form-select" id="device-select">
                        <option selected disabled value="">请选择一个设备以生成拓扑图</option>
                        {% for device in devices %}
                        <option value="{{ device.id }}">{{ device.name }} (ID: {{ device.id }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <!-- vis.js拓扑图将在此div中渲染 -->
                <div id="mynetwork"></div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入vis.js网络图库 -->
    <script type="text/javascript" src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <script type="text/javascript">
        // 等待DOM内容加载完毕后执行脚本
        document.addEventListener('DOMContentLoaded', function () {
            const deviceSelect = document.getElementById('device-select');
            const container = document.getElementById('mynetwork');
            let network = null;

            // vis.js网络图的配置选项
            const options = {
                interaction: {
                    dragNodes: true, // 是否可以拖动节点
                    dragView: true,  // 是否可以拖动视图
                    hover: true,     // 鼠标悬停时是否高亮
                    zoomView: true,  // 是否可以缩放视图
                    tooltipDelay: 300,
                },
                physics: { // 物理引擎配置，用于稳定图形
                    enabled: true,
                    solver: 'barnesHut',
                    barnesHut: {
                        gravitationalConstant: -8000,
                        springConstant: 0.04,
                        springLength: 95
                    },
                    stabilization: {
                        iterations: 1000
                    }
                },
                nodes: { // 节点样式配置
                    shape: 'box',
                    margin: 10,
                    widthConstraint: {
                        maximum: 200
                    }
                },
                edges: { // 连接线样式配置
                    arrows: {
                        to: { enabled: true, scaleFactor: 1, type: 'arrow' } // 显示指向箭头
                    },
                    color: {
                        color: '#848484',
                        highlight: '#2B7CE9',
                        hover: '#2B7CE9',
                    },
                    smooth: { // 连接线平滑显示
                        type: 'cubicBezier'
                    }
                },
                layout: {
                    hierarchical: false // 是否启用层级布局
                }
            };

            // 监听设备选择下拉框的change事件
            deviceSelect.addEventListener('change', function() {
                const deviceId = this.value;
                if (!deviceId) {
                    return;
                }

                // 清空容器，显示加载提示
                container.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><strong class="ms-3">正在加载拓扑图...</strong></div>';

                // 调用后端的API获取指定设备的电力链路数据
                fetch(`/api/power-chain/${deviceId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应错误，无法获取数据');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 将获取到的节点和边数据包装成vis.js需要的数据集格式
                        const graphData = {
                            nodes: new vis.DataSet(data.nodes),
                            edges: new vis.DataSet(data.edges)
                        };

                        // 如果已存在网络图实例，先销毁
                        if (network) {
                            network.destroy();
                        }
                        // 创建新的vis.Network实例，并传入容器、数据和配置
                        network = new vis.Network(container, graphData, options);
                    })
                    .catch(error => {
                        // 如果API调用失败，在容器中显示错误信息
                        console.error('获取拓扑数据失败:', error);
                        container.innerHTML = `<div class="alert alert-danger" role="alert">加载拓扑图失败: ${error.message}</div>`;
                    });
            });
        });
    </script>
</body>
</html>