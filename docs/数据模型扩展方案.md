# 数据模型扩展方案 - 拓扑图功能

## 现有模型分析

### Device模型现状
```python
class Device(Base):
    __tablename__ = "devices"
    
    # 基础字段
    id = Column(Integer, primary_key=True, index=True)
    asset_id = Column(String, unique=True, index=True, nullable=False)
    name = Column(String, index=True, nullable=False)
    station = Column(String, index=True, nullable=False)
    model = Column(String)
    device_type = Column(String, index=True, nullable=True)
    location = Column(String)
    power_rating = Column(String)
    vendor = Column(String)
    commission_date = Column(String)
    remark = Column(String)
    
    # 关系字段
    source_connections = relationship(...)
    target_connections = relationship(...)
```

### Connection模型现状
```python
class Connection(Base):
    __tablename__ = "connections"
    
    # 基础字段
    id = Column(Integer, primary_key=True, index=True)
    source_device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    target_device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    
    # 详细的连接信息（18个字段）
    source_port = Column(String(100))
    target_port = Column(String(100))
    connection_type = Column(String(20), nullable=True, default=None)
    # ... 其他连接相关字段
```

## 扩展方案设计

### 设计原则

1. **最小侵入性**: 在现有模型基础上添加字段，不破坏现有功能
2. **向后兼容**: 新字段设置合理默认值，确保现有数据正常工作
3. **可选性**: 拓扑功能为可选功能，不影响核心业务
4. **扩展性**: 为未来功能预留扩展空间

### 方案一：直接扩展现有模型（推荐）

#### Device模型扩展

```python
class Device(Base):
    __tablename__ = "devices"
    
    # === 现有字段保持不变 ===
    id = Column(Integer, primary_key=True, index=True)
    asset_id = Column(String, unique=True, index=True, nullable=False)
    name = Column(String, index=True, nullable=False)
    station = Column(String, index=True, nullable=False)
    model = Column(String)
    device_type = Column(String, index=True, nullable=True)
    location = Column(String)
    power_rating = Column(String)
    vendor = Column(String)
    commission_date = Column(String)
    remark = Column(String)
    
    # === 新增拓扑相关字段 ===
    
    # 拓扑坐标信息
    topo_x = Column(Float, default=None, comment="拓扑图X坐标")
    topo_y = Column(Float, default=None, comment="拓扑图Y坐标")
    topo_locked = Column(String, default="false", comment="位置是否锁定")
    
    # 拓扑显示属性
    topo_color = Column(String, default=None, comment="节点颜色")
    topo_size = Column(Integer, default=20, comment="节点大小")
    topo_shape = Column(String, default="ellipse", comment="节点形状")
    topo_visible = Column(String, default="true", comment="是否在拓扑图中显示")
    
    # 拓扑分组信息
    topo_group = Column(String, default=None, comment="拓扑分组")
    topo_layer = Column(Integer, default=0, comment="拓扑层级")
    
    # 拓扑元数据
    topo_updated_at = Column(String, default=None, comment="拓扑信息最后更新时间")
    
    # === 现有关系保持不变 ===
    source_connections = relationship(
        "Connection", 
        foreign_keys="[Connection.source_device_id]", 
        back_populates="source_device"
    )
    target_connections = relationship(
        "Connection", 
        foreign_keys="[Connection.target_device_id]", 
        back_populates="target_device"
    )
```

#### Connection模型扩展

```python
class Connection(Base):
    __tablename__ = "connections"
    
    # === 现有字段保持不变 ===
    id = Column(Integer, primary_key=True, index=True)
    source_device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    target_device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    
    # 现有的18个连接详细字段保持不变
    source_port = Column(String(100))
    target_port = Column(String(100))
    connection_type = Column(String(20), nullable=True, default=None)
    # ... 其他现有字段
    
    # === 新增拓扑相关字段 ===
    
    # 拓扑显示属性
    topo_color = Column(String, default="#848484", comment="连接线颜色")
    topo_width = Column(Integer, default=1, comment="连接线宽度")
    topo_style = Column(String, default="solid", comment="连接线样式：solid/dashed/dotted")
    topo_visible = Column(String, default="true", comment="是否在拓扑图中显示")
    
    # 拓扑路径信息
    topo_weight = Column(Float, default=1.0, comment="连接权重，用于路径计算")
    topo_direction = Column(String, default="bidirectional", comment="连接方向：bidirectional/source_to_target/target_to_source")
    
    # 拓扑分组
    topo_group = Column(String, default=None, comment="连接分组")
    
    # 拓扑元数据
    topo_updated_at = Column(String, default=None, comment="拓扑信息最后更新时间")
    
    # === 现有关系保持不变 ===
    source_device = relationship(
        "Device", 
        foreign_keys=[source_device_id], 
        back_populates="source_connections"
    )
    target_device = relationship(
        "Device", 
        foreign_keys=[target_device_id], 
        back_populates="target_connections"
    )
```

### 方案二：独立拓扑配置表（备选）

如果希望保持现有模型完全不变，可以创建独立的拓扑配置表：

```python
class TopologyNodeConfig(Base):
    """拓扑节点配置表"""
    __tablename__ = "topology_node_configs"
    
    id = Column(Integer, primary_key=True, index=True)
    device_id = Column(Integer, ForeignKey("devices.id"), unique=True, nullable=False)
    
    # 坐标信息
    x = Column(Float, default=None)
    y = Column(Float, default=None)
    locked = Column(String, default="false")
    
    # 显示属性
    color = Column(String, default=None)
    size = Column(Integer, default=20)
    shape = Column(String, default="ellipse")
    visible = Column(String, default="true")
    
    # 分组信息
    group_name = Column(String, default=None)
    layer = Column(Integer, default=0)
    
    # 元数据
    created_at = Column(String)
    updated_at = Column(String)
    
    # 关系
    device = relationship("Device")

class TopologyEdgeConfig(Base):
    """拓扑连接配置表"""
    __tablename__ = "topology_edge_configs"
    
    id = Column(Integer, primary_key=True, index=True)
    connection_id = Column(Integer, ForeignKey("connections.id"), unique=True, nullable=False)
    
    # 显示属性
    color = Column(String, default="#848484")
    width = Column(Integer, default=1)
    style = Column(String, default="solid")
    visible = Column(String, default="true")
    
    # 路径信息
    weight = Column(Float, default=1.0)
    direction = Column(String, default="bidirectional")
    
    # 分组
    group_name = Column(String, default=None)
    
    # 元数据
    created_at = Column(String)
    updated_at = Column(String)
    
    # 关系
    connection = relationship("Connection")
```

## 推荐方案分析

### 方案一优势（推荐）

1. **简单直接**: 直接在现有模型上扩展，减少复杂性
2. **性能更好**: 避免额外的JOIN查询
3. **维护简单**: 数据一致性更容易保证
4. **API简洁**: 获取设备信息时直接包含拓扑属性

### 方案一实施步骤

#### 步骤1: 数据库迁移脚本

```python
# migration_add_topology_fields.py
from sqlalchemy import text
from models import engine

def upgrade_database():
    """添加拓扑相关字段"""
    with engine.connect() as conn:
        # Device表添加拓扑字段
        device_fields = [
            "ALTER TABLE devices ADD COLUMN topo_x REAL DEFAULT NULL",
            "ALTER TABLE devices ADD COLUMN topo_y REAL DEFAULT NULL", 
            "ALTER TABLE devices ADD COLUMN topo_locked TEXT DEFAULT 'false'",
            "ALTER TABLE devices ADD COLUMN topo_color TEXT DEFAULT NULL",
            "ALTER TABLE devices ADD COLUMN topo_size INTEGER DEFAULT 20",
            "ALTER TABLE devices ADD COLUMN topo_shape TEXT DEFAULT 'ellipse'",
            "ALTER TABLE devices ADD COLUMN topo_visible TEXT DEFAULT 'true'",
            "ALTER TABLE devices ADD COLUMN topo_group TEXT DEFAULT NULL",
            "ALTER TABLE devices ADD COLUMN topo_layer INTEGER DEFAULT 0",
            "ALTER TABLE devices ADD COLUMN topo_updated_at TEXT DEFAULT NULL"
        ]
        
        # Connection表添加拓扑字段
        connection_fields = [
            "ALTER TABLE connections ADD COLUMN topo_color TEXT DEFAULT '#848484'",
            "ALTER TABLE connections ADD COLUMN topo_width INTEGER DEFAULT 1",
            "ALTER TABLE connections ADD COLUMN topo_style TEXT DEFAULT 'solid'",
            "ALTER TABLE connections ADD COLUMN topo_visible TEXT DEFAULT 'true'",
            "ALTER TABLE connections ADD COLUMN topo_weight REAL DEFAULT 1.0",
            "ALTER TABLE connections ADD COLUMN topo_direction TEXT DEFAULT 'bidirectional'",
            "ALTER TABLE connections ADD COLUMN topo_group TEXT DEFAULT NULL",
            "ALTER TABLE connections ADD COLUMN topo_updated_at TEXT DEFAULT NULL"
        ]
        
        # 执行迁移
        for sql in device_fields + connection_fields:
            try:
                conn.execute(text(sql))
                print(f"执行成功: {sql}")
            except Exception as e:
                print(f"执行失败: {sql}, 错误: {e}")
        
        conn.commit()
        print("数据库迁移完成")

if __name__ == "__main__":
    upgrade_database()
```

#### 步骤2: 模型更新

更新 `models.py` 文件，添加上述拓扑字段定义。

#### 步骤3: API扩展

```python
# 在main.py中添加拓扑相关API

@app.get("/api/topology/graph")
async def get_topology_graph(db: Session = Depends(get_db)):
    """获取拓扑图数据"""
    devices = db.query(Device).filter(Device.topo_visible == "true").all()
    connections = db.query(Connection).filter(Connection.topo_visible == "true").all()
    
    # 构建节点数据
    nodes = []
    for device in devices:
        node = {
            "id": device.id,
            "label": device.name,
            "group": device.device_type,
            "x": device.topo_x,
            "y": device.topo_y,
            "color": device.topo_color,
            "size": device.topo_size,
            "shape": device.topo_shape,
            "locked": device.topo_locked == "true",
            "data": {
                "asset_id": device.asset_id,
                "station": device.station,
                "device_type": device.device_type,
                "location": device.location
            }
        }
        nodes.append(node)
    
    # 构建边数据
    edges = []
    for conn in connections:
        edge = {
            "id": conn.id,
            "source": conn.source_device_id,
            "target": conn.target_device_id,
            "color": conn.topo_color,
            "width": conn.topo_width,
            "style": conn.topo_style,
            "weight": conn.topo_weight,
            "direction": conn.topo_direction,
            "data": {
                "connection_type": conn.connection_type,
                "source_port": conn.source_port,
                "target_port": conn.target_port
            }
        }
        edges.append(edge)
    
    return {"nodes": nodes, "edges": edges}

@app.post("/api/topology/layout")
async def save_layout(layout_data: dict, db: Session = Depends(get_db)):
    """保存拓扑布局"""
    try:
        for node_data in layout_data.get("nodes", []):
            device_id = node_data["id"]
            x = node_data.get("x")
            y = node_data.get("y")
            
            device = db.query(Device).filter(Device.id == device_id).first()
            if device:
                device.topo_x = x
                device.topo_y = y
                device.topo_updated_at = datetime.now().isoformat()
        
        db.commit()
        return {"status": "success", "message": "布局保存成功"}
    except Exception as e:
        db.rollback()
        return {"status": "error", "message": str(e)}
```

## 数据迁移策略

### 现有数据处理

1. **默认值设置**: 所有新字段都有合理的默认值
2. **渐进式迁移**: 用户可以逐步配置拓扑属性
3. **自动初始化**: 首次访问拓扑图时自动生成初始布局

### 初始布局生成

```python
def generate_initial_layout(db: Session):
    """为没有坐标的设备生成初始布局"""
    devices_without_coords = db.query(Device).filter(
        Device.topo_x.is_(None) | Device.topo_y.is_(None)
    ).all()
    
    if not devices_without_coords:
        return
    
    # 使用简单的网格布局
    import math
    count = len(devices_without_coords)
    cols = math.ceil(math.sqrt(count))
    
    for i, device in enumerate(devices_without_coords):
        row = i // cols
        col = i % cols
        device.topo_x = col * 150 + 100  # 150px间距
        device.topo_y = row * 100 + 100  # 100px间距
        device.topo_updated_at = datetime.now().isoformat()
    
    db.commit()
```

## 总结

推荐采用**方案一**（直接扩展现有模型），因为：

1. **实施简单**: 只需添加字段，不需要复杂的表关系
2. **性能优秀**: 避免额外的JOIN查询
3. **维护方便**: 数据一致性容易保证
4. **扩展性好**: 为未来功能预留了足够空间

通过这个扩展方案，我们可以在保持现有功能完整性的前提下，为拓扑图功能提供强大的数据支持。