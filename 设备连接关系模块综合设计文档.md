# 设备连接关系模块综合设计文档

## 1. 项目概述

### 1.1 项目背景
本文档描述了安吉电信动力设备管理系统中设备连接关系模块的完整设计方案。该模块专门用于管理动力设备之间的供电连接关系，包括电缆连接、铜排连接和母线连接的可视化、管理和分析。

### 1.2 业务需求
- **供电关系管理**：系统只管理设备间的供电关系，不涉及光纤、数据线等其他连接类型
- **连接介质管理**：支持电缆、铜排、母线三种连接介质的详细信息记录
- **规格信息**：记录电缆规格、铜排规格、熔丝/空开信息、并联数量等技术参数
- **层级关系**：支持上下级和上下游关系的记录和管理
- **可视化展示**：通过拓扑图直观展示设备间的供电链路关系
- **连接管理**：支持连接关系的增删改查操作

### 1.3 设计原则
- **向后兼容**：不影响现有设备管理和生命周期管理模块的稳定性
- **渐进增强**：在现有架构基础上扩展功能，避免大规模重构
- **数据一致性**：确保与Excel导入数据格式完全兼容
- **小步前进**：分阶段实施，每个阶段都有可交付的功能

## 2. 现状分析

### 2.1 代码现状诊断

**已有基础设施：**
- ✅ Connection数据模型已存在（models.py）
- ✅ 基础拓扑图可视化已实现（graph.html + vis.js）
- ✅ 设备管理基础架构完善
- ✅ Excel数据导入功能已有

**关键问题识别：**
1. **API路径不匹配**：前端调用`/api/power-chain/`，后端实际为`/graph_data/`
2. **数据模型不足**：现有Connection模型只有基础字段（source_device_id, target_device_id, source_port, target_port, cable_type）
3. **功能缺失**：缺少连接CRUD管理界面和API
4. **数据结构简单**：无法支持Excel中的详细连接信息

### 2.2 Excel数据结构分析

**现有连接数据结构（sheet2 - 连接表）：**

根据实际Excel文件，连接表包含18列字段：
1. A端设备名称
2. A端熔丝编号
3. A端熔丝规格
4. A端空开编号
5. A端空开规格
6. 上下级
7. 上下游
8. 连接类型（电缆/铜排/母线）
9. 电缆型号
10. B端设备名称
11. B端熔丝编号
12. B端熔丝规格
13. B端空开编号
14. 空开规格
15. B端设备位置（非动力设备）
16. A端设备照片
17. B端设备照片
18. 备注

**数据特点分析：**
- ✅ 数据完整性：18列50行，结构清晰
- ✅ 包含详细的熔丝和空开信息
- ✅ 支持上下级和上下游关系
- ✅ 包含连接类型和电缆型号
- ✅ 支持设备照片和备注信息
- ⚠️ 需要标准化处理和字段映射

## 3. 技术架构设计

### 3.1 架构选择评估

**当前架构：**
- 后端：FastAPI + SQLAlchemy + SQLite
- 前端：HTML + JavaScript + Bootstrap 5 + vis.js
- 数据库：SQLite

**架构优势：**
- ✅ 轻量级，适合中小型项目
- ✅ 技术栈统一，维护成本低
- ✅ 现有团队技能匹配
- ✅ 部署简单，无复杂依赖

**架构风险：**
- ⚠️ SQLite并发性能有限
- ⚠️ 单体架构，扩展性受限
- ⚠️ 前端JavaScript代码可能变得复杂

**结论：** 当前架构适合项目规模，建议保持现有技术栈，采用渐进式增强策略。

### 3.2 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层     │    │    API接口层     │    │   数据访问层     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ 拓扑图可视化     │◄──►│ 连接管理API     │◄──►│ Connection模型   │
│ 连接管理界面     │    │ 拓扑图API       │    │ Device模型      │
│ 统计分析界面     │    │ 统计分析API     │    │ 数据库操作      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 4. 数据模型设计

### 4.1 Connection模型扩展

基于Excel数据结构和现有模型，设计完整的Connection模型：

```python
class Connection(Base):
    __tablename__ = "connections"
    
    # 基础字段
    id = Column(Integer, primary_key=True, index=True)
    source_device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    target_device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    
    # A端（源端）信息
    source_port = Column(String(100))  # A端端口
    source_fuse_number = Column(String(50))  # A端熔丝编号
    source_fuse_spec = Column(String(100))  # A端熔丝规格
    source_breaker_number = Column(String(50))  # A端空开编号
    source_breaker_spec = Column(String(100))  # A端空开规格
    
    # B端（目标端）信息
    target_port = Column(String(100))  # B端端口
    target_fuse_number = Column(String(50))  # B端熔丝编号
    target_fuse_spec = Column(String(100))  # B端熔丝规格
    target_breaker_number = Column(String(50))  # B端空开编号
    target_breaker_spec = Column(String(100))  # B端空开规格
    target_device_location = Column(String(200))  # B端设备位置（非动力设备）
    
    # 连接信息
    connection_type = Column(String(20), nullable=False)  # 连接类型：cable/busbar/busway
    cable_model = Column(String(100))  # 电缆型号
    hierarchy_relation = Column(String(20))  # 上下级关系（如：A上B下）
    upstream_downstream = Column(String(20))  # 上下游关系（如：上游、下游）
    
    # 技术参数（从电缆型号和规格推导）
    cable_specification = Column(String(100))  # 电缆规格（如：RVVZ-240mm²）
    parallel_count = Column(Integer, default=1)  # 并联数量（从备注解析）
    rated_current = Column(Float)  # 额定电流(A)（从熔丝/空开规格推导）
    cable_length = Column(Float)  # 电缆长度(m)
    
    # 附加信息
    source_device_photo = Column(String(500))  # A端设备照片路径
    target_device_photo = Column(String(500))  # B端设备照片路径
    remark = Column(Text)  # 备注
    installation_date = Column(Date)  # 安装日期
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # 关联关系
    source_device = relationship("Device", foreign_keys=[source_device_id], back_populates="source_connections")
    target_device = relationship("Device", foreign_keys=[target_device_id], back_populates="target_connections")
```

### 4.2 字段映射表

| Excel字段 | 数据库字段 | 类型 | 说明 |
|-----------|------------|------|------|
| A端设备名称 | source_device_id | Integer | 通过设备名称查找ID |
| A端熔丝编号 | source_fuse_number | String | A端熔丝编号 |
| A端熔丝规格 | source_fuse_spec | String | A端熔丝规格 |
| A端空开编号 | source_breaker_number | String | A端空开编号 |
| A端空开规格 | source_breaker_spec | String | A端空开规格 |
| 上下级 | hierarchy_relation | String | 上下级关系 |
| 上下游 | upstream_downstream | String | 上下游关系 |
| 连接类型 | connection_type | String | cable/busbar/busway |
| 电缆型号 | cable_model | String | 电缆型号 |
| B端设备名称 | target_device_id | Integer | 通过设备名称查找ID |
| B端熔丝编号 | target_fuse_number | String | B端熔丝编号 |
| B端熔丝规格 | target_fuse_spec | String | B端熔丝规格 |
| B端空开编号 | target_breaker_number | String | B端空开编号 |
| 空开规格 | target_breaker_spec | String | B端空开规格 |
| B端设备位置 | target_device_location | String | B端设备位置 |
| A端设备照片 | source_device_photo | String | A端设备照片路径 |
| B端设备照片 | target_device_photo | String | B端设备照片路径 |
| 备注 | remark | Text | 备注信息 |

### 4.3 数据处理规则

**连接类型标准化：**
- "电缆" → "cable"
- "铜排" → "busbar"
- "母线" → "busway"

**并联数量解析：**
- 从备注字段解析并联信息（如："混合并联：A端熔丝*2+A、B间电缆*4"）
- 提取数字作为parallel_count

**额定电流推导：**
- 从熔丝规格解析电流值（如："NT4(500A)" → 500A）
- 从空开规格解析电流值（如："RT16Z-3(500A)" → 500A）

## 5. API接口设计

### 5.1 连接管理API

#### 5.1.1 获取连接列表
```
GET /api/connections
参数：
- page: 页码（可选，默认1）
- size: 每页数量（可选，默认20）
- connection_type: 连接类型过滤（可选）
- source_device_id: 源设备ID过滤（可选）
- hierarchy_relation: 上下级关系过滤（可选）

响应：
{
  "total": 100,
  "page": 1,
  "size": 20,
  "items": [
    {
      "id": 1,
      "source_device": {
        "id": 1,
        "name": "新大楼一楼综合机房_1#直流系统直配屏E15",
        "asset_id": "A001"
      },
      "target_device": {
        "id": 2,
        "name": "新大楼三楼电力室_1#直流系统蓄电池01",
        "asset_id": "A002"
      },
      "connection_type": "cable",
      "cable_model": "RVVZ-240mm²",
      "source_fuse_number": "BF1（电池1）",
      "source_fuse_spec": "NT4(500A)",
      "hierarchy_relation": "A上B下",
      "upstream_downstream": "上游",
      "parallel_count": 4,
      "rated_current": 500.0,
      "remark": "混合并联：A端熔丝*2+A、B间电缆*4"
    }
  ]
}
```

#### 5.1.2 创建连接
```
POST /api/connections
请求体：
{
  "source_device_id": 1,
  "target_device_id": 2,
  "source_fuse_number": "BF1（电池1）",
  "source_fuse_spec": "NT4(500A)",
  "connection_type": "cable",
  "cable_model": "RVVZ-240mm²",
  "hierarchy_relation": "A上B下",
  "upstream_downstream": "上游",
  "parallel_count": 4,
  "remark": "混合并联：A端熔丝*2+A、B间电缆*4"
}
```

#### 5.1.3 更新连接
```
PUT /api/connections/{connection_id}
请求体：同创建连接
```

#### 5.1.4 删除连接
```
DELETE /api/connections/{connection_id}
```

### 5.2 拓扑图API

#### 5.2.1 修复现有API路径
```
# 保持现有功能，修复路径不一致问题
GET /api/power-chain/{device_id}  # 新增，与前端保持一致
GET /graph_data/{device_id}       # 保留，向后兼容

响应格式（增强）：
{
  "nodes": [
    {
      "id": 1,
      "label": "新大楼一楼综合机房_1#直流系统直配屏E15",
      "title": "详细信息HTML",
      "level": 0,
      "device_type": "直流配电屏",
      "power_rating": "10kVA"
    }
  ],
  "edges": [
    {
      "from": 1,
      "to": 2,
      "arrows": "to",
      "label": "RVVZ-240mm² (500A)",
      "connection_type": "cable",
      "connection_id": 1,
      "color": {"color": "#2196F3"},  # 电缆用蓝色
      "width": 3,
      "title": "连接详情HTML",
      "hierarchy_relation": "A上B下",
      "upstream_downstream": "上游"
    }
  ]
}
```

### 5.3 统计分析API

#### 5.3.1 连接统计
```
GET /api/connections/statistics
响应：
{
  "total_connections": 50,
  "by_type": {
    "cable": 45,
    "busbar": 3,
    "busway": 2
  },
  "by_hierarchy": {
    "A上B下": 30,
    "A下B上": 15,
    "平级": 5
  },
  "by_upstream_downstream": {
    "上游": 25,
    "下游": 20,
    "中游": 5
  },
  "parallel_connections": 15,
  "total_current_capacity": 25000.0
}
```

#### 5.3.2 端口统计API
```
GET /api/ports/statistics
响应：
{
  "device_port_summary": {
    "total_devices": 25,
    "total_ports": 150,
    "connected_ports": 100,
    "idle_ports": 50,
    "utilization_rate": 66.67
  },
  "port_type_statistics": {
    "fuse_ports": {
      "total": 120,
      "connected": 85,
      "idle": 35,
      "utilization_rate": 70.83
    },
    "breaker_ports": {
      "total": 30,
      "connected": 15,
      "idle": 15,
      "utilization_rate": 50.0
    }
  },
  "capacity_statistics": {
    "by_rating": {
      "63A": {"total": 40, "connected": 30, "idle": 10},
      "100A": {"total": 35, "connected": 25, "idle": 10},
      "160A": {"total": 25, "connected": 20, "idle": 5},
      "250A": {"total": 20, "connected": 15, "idle": 5},
      "400A": {"total": 15, "connected": 10, "idle": 5},
      "630A": {"total": 10, "connected": 0, "idle": 10},
      "1000A": {"total": 5, "connected": 0, "idle": 5}
    },
    "high_capacity_available": {
      "630A_above": 15,
      "400A_above": 20,
      "250A_above": 25
    }
  },
  "device_port_details": [
    {
      "device_name": "配电柜A",
      "total_ports": 12,
      "connected_ports": 8,
      "idle_ports": 4,
      "utilization_rate": 66.67,
      "port_breakdown": {
        "fuse_ports": {"total": 10, "connected": 7, "idle": 3},
        "breaker_ports": {"total": 2, "connected": 1, "idle": 1}
      }
    }
  ]
}
```

#### 5.3.3 设备端口详情API
```
GET /api/devices/{device_id}/ports
响应：
{
  "device_info": {
    "id": 1,
    "name": "配电柜A",
    "station": "主配电室",
    "device_type": "配电柜"
  },
  "port_summary": {
    "total_ports": 12,
    "connected_ports": 8,
    "idle_ports": 4,
    "utilization_rate": 66.67
  },
  "ports": [
    {
      "port_name": "熔丝-F1",
      "port_type": "fuse",
      "rating": "63A",
      "status": "connected",
      "connection_info": {
        "target_device": "负荷设备1",
        "target_port": "空开-B1",
        "cable_spec": "YJV-4×16"
      }
    },
    {
      "port_name": "熔丝-F2",
      "port_type": "fuse",
      "rating": "63A",
      "status": "idle",
      "connection_info": null
    }
  ]
}
```

### 5.4 端口统计功能实现方案

#### 5.4.1 核心实现思路

**方案概述：**
基于现有连接数据推导端口使用情况，通过统计连接表中的熔丝和空开数量来获得设备端口总数，并分析端口的连接状态。

**技术要点：**
1. **端口识别逻辑**：通过连接表中的`source_fuse_number`、`source_breaker_number`、`target_fuse_number`、`target_breaker_number`字段识别端口
2. **端口状态判断**：有连接记录的端口为"已连接"，仅在连接表中出现但无对应连接的为"空闲"
3. **容量等级提取**：从熔丝规格和空开规格字段中解析电流等级（如"NT4(500A)" → "500A"）
4. **设备端口聚合**：按设备分组统计各设备的端口使用情况

#### 5.4.2 数据统计算法

**端口总数统计：**
```sql
-- 统计每个设备的端口总数（基于熔丝和空开数量）
SELECT 
    d.id as device_id,
    d.name as device_name,
    COUNT(DISTINCT CASE WHEN c.source_fuse_number IS NOT NULL THEN c.source_fuse_number END) +
    COUNT(DISTINCT CASE WHEN c.target_fuse_number IS NOT NULL THEN c.target_fuse_number END) +
    COUNT(DISTINCT CASE WHEN c.source_breaker_number IS NOT NULL THEN c.source_breaker_number END) +
    COUNT(DISTINCT CASE WHEN c.target_breaker_number IS NOT NULL THEN c.target_breaker_number END) as total_ports
FROM devices d
LEFT JOIN connections c ON (d.id = c.source_device_id OR d.id = c.target_device_id)
GROUP BY d.id, d.name;
```

**端口使用情况统计：**
```sql
-- 统计已连接端口数（有完整连接记录的端口）
SELECT 
    device_id,
    COUNT(*) as connected_ports
FROM (
    SELECT source_device_id as device_id FROM connections WHERE target_device_id IS NOT NULL
    UNION ALL
    SELECT target_device_id as device_id FROM connections WHERE source_device_id IS NOT NULL
) connected_ports_union
GROUP BY device_id;
```

**容量等级统计：**
```python
def extract_rating_from_spec(spec_string):
    """
    从规格字符串中提取电流等级
    例如："NT4(500A)" -> "500A"
         "RT16Z-3(63A)" -> "63A"
    """
    import re
    if not spec_string:
        return None
    
    # 匹配括号内的电流值
    match = re.search(r'\((\d+)A\)', spec_string)
    if match:
        return f"{match.group(1)}A"
    
    # 匹配直接的电流值
    match = re.search(r'(\d+)A', spec_string)
    if match:
        return f"{match.group(1)}A"
    
    return "未知"
```

#### 5.4.3 后端实现代码结构

**端口统计服务类：**
```python
class PortStatisticsService:
    def __init__(self, db: Session):
        self.db = db
    
    def get_port_statistics(self) -> dict:
        """获取全局端口统计信息"""
        # 1. 设备端口总览
        device_port_summary = self._get_device_port_summary()
        
        # 2. 端口类型统计
        port_type_statistics = self._get_port_type_statistics()
        
        # 3. 容量统计
        capacity_statistics = self._get_capacity_statistics()
        
        # 4. 设备端口详情
        device_port_details = self._get_device_port_details()
        
        return {
            "device_port_summary": device_port_summary,
            "port_type_statistics": port_type_statistics,
            "capacity_statistics": capacity_statistics,
            "device_port_details": device_port_details
        }
    
    def _get_device_port_summary(self) -> dict:
        """获取设备端口总览"""
        # 统计总设备数
        total_devices = self.db.query(Device).count()
        
        # 统计总端口数（基于连接表中的熔丝和空开）
        port_query = self.db.query(
            func.count(func.distinct(Connection.source_fuse_number)).label('source_fuse'),
            func.count(func.distinct(Connection.target_fuse_number)).label('target_fuse'),
            func.count(func.distinct(Connection.source_breaker_number)).label('source_breaker'),
            func.count(func.distinct(Connection.target_breaker_number)).label('target_breaker')
        ).filter(
            or_(
                Connection.source_fuse_number.isnot(None),
                Connection.target_fuse_number.isnot(None),
                Connection.source_breaker_number.isnot(None),
                Connection.target_breaker_number.isnot(None)
            )
        ).first()
        
        total_ports = (port_query.source_fuse or 0) + (port_query.target_fuse or 0) + \
                     (port_query.source_breaker or 0) + (port_query.target_breaker or 0)
        
        # 统计已连接端口数
        connected_ports = self.db.query(Connection).filter(
            and_(
                Connection.source_device_id.isnot(None),
                Connection.target_device_id.isnot(None)
            )
        ).count()
        
        idle_ports = total_ports - connected_ports
        utilization_rate = (connected_ports / total_ports * 100) if total_ports > 0 else 0
        
        return {
            "total_devices": total_devices,
            "total_ports": total_ports,
            "connected_ports": connected_ports,
            "idle_ports": idle_ports,
            "utilization_rate": round(utilization_rate, 2)
        }
    
    def _get_port_type_statistics(self) -> dict:
        """获取端口类型统计"""
        # 统计熔丝端口
        fuse_total = self.db.query(
            func.count(func.distinct(Connection.source_fuse_number)) +
            func.count(func.distinct(Connection.target_fuse_number))
        ).filter(
            or_(
                Connection.source_fuse_number.isnot(None),
                Connection.target_fuse_number.isnot(None)
            )
        ).scalar() or 0
        
        # 统计空开端口
        breaker_total = self.db.query(
            func.count(func.distinct(Connection.source_breaker_number)) +
            func.count(func.distinct(Connection.target_breaker_number))
        ).filter(
            or_(
                Connection.source_breaker_number.isnot(None),
                Connection.target_breaker_number.isnot(None)
            )
        ).scalar() or 0
        
        # 统计已连接的熔丝和空开端口
        fuse_connected = self.db.query(Connection).filter(
            and_(
                or_(
                    Connection.source_fuse_number.isnot(None),
                    Connection.target_fuse_number.isnot(None)
                ),
                Connection.source_device_id.isnot(None),
                Connection.target_device_id.isnot(None)
            )
        ).count()
        
        breaker_connected = self.db.query(Connection).filter(
            and_(
                or_(
                    Connection.source_breaker_number.isnot(None),
                    Connection.target_breaker_number.isnot(None)
                ),
                Connection.source_device_id.isnot(None),
                Connection.target_device_id.isnot(None)
            )
        ).count()
        
        return {
            "fuse_ports": {
                "total": fuse_total,
                "connected": fuse_connected,
                "idle": fuse_total - fuse_connected,
                "utilization_rate": round((fuse_connected / fuse_total * 100) if fuse_total > 0 else 0, 2)
            },
            "breaker_ports": {
                "total": breaker_total,
                "connected": breaker_connected,
                "idle": breaker_total - breaker_connected,
                "utilization_rate": round((breaker_connected / breaker_total * 100) if breaker_total > 0 else 0, 2)
            }
        }
    
    def _get_capacity_statistics(self) -> dict:
        """获取容量统计"""
        # 获取所有连接的规格信息
        connections = self.db.query(Connection).all()
        
        capacity_stats = {}
        high_capacity_available = {"630A_above": 0, "400A_above": 0, "250A_above": 0}
        
        for conn in connections:
            # 处理源端规格
            for spec_field in [conn.source_fuse_spec, conn.source_breaker_spec, 
                             conn.target_fuse_spec, conn.target_breaker_spec]:
                if spec_field:
                    rating = self._extract_rating_from_spec(spec_field)
                    if rating and rating != "未知":
                        if rating not in capacity_stats:
                            capacity_stats[rating] = {"total": 0, "connected": 0, "idle": 0}
                        
                        capacity_stats[rating]["total"] += 1
                        
                        # 判断是否已连接
                        if conn.source_device_id and conn.target_device_id:
                            capacity_stats[rating]["connected"] += 1
                        else:
                            capacity_stats[rating]["idle"] += 1
                            
                            # 统计大容量可用端口
                            rating_value = int(rating.replace('A', ''))
                            if rating_value >= 630:
                                high_capacity_available["630A_above"] += 1
                            if rating_value >= 400:
                                high_capacity_available["400A_above"] += 1
                            if rating_value >= 250:
                                high_capacity_available["250A_above"] += 1
        
        return {
            "by_rating": capacity_stats,
            "high_capacity_available": high_capacity_available
        }
    
    def _extract_rating_from_spec(self, spec_string: str) -> str:
        """从规格字符串中提取电流等级"""
        import re
        if not spec_string:
            return "未知"
        
        # 匹配括号内的电流值
        match = re.search(r'\((\d+)A\)', spec_string)
        if match:
            return f"{match.group(1)}A"
        
        # 匹配直接的电流值
        match = re.search(r'(\d+)A', spec_string)
        if match:
            return f"{match.group(1)}A"
        
        return "未知"
```

#### 5.4.4 命名规范建议

**后端API字段命名：**
- `device_port_summary` - 设备端口总览
- `port_type_statistics` - 端口类型统计
- `capacity_statistics` - 容量统计
- `total_ports` - 总端口数
- `connected_ports` - 已连接端口数
- `idle_ports` - 空闲端口数
- `utilization_rate` - 利用率
- `fuse_ports` - 熔丝端口
- `breaker_ports` - 空开端口
- `by_rating` - 按容量等级
- `high_capacity_available` - 大容量可用端口

**前端函数命名：**
- `loadPortStatistics()` - 加载端口统计数据
- `renderPortStatistics()` - 渲染端口统计界面
- `updateOverviewCards()` - 更新概览卡片
- `updatePortTypeStatistics()` - 更新端口类型统计
- `updateCapacityTable()` - 更新容量统计表格
- `updateDevicePortTable()` - 更新设备端口详情表格
- `renderCapacityChart()` - 渲染容量分布图表
- `exportPortStatistics()` - 导出端口统计
- `refreshPortStatistics()` - 刷新端口统计

#### 5.4.5 性能优化考虑

**数据库查询优化：**
1. 为连接表的端口字段添加索引
2. 使用聚合查询减少数据传输量
3. 实现查询结果缓存机制

**前端性能优化：**
1. 使用虚拟滚动处理大量设备数据
2. 图表数据懒加载
3. 统计数据定时刷新而非实时刷新

**缓存策略：**
```python
# Redis缓存端口统计数据，缓存时间5分钟
@cache(expire=300)
def get_port_statistics_cached():
    return port_statistics_service.get_port_statistics()
```

## 6. 前端界面设计

### 6.1 拓扑图可视化增强

#### 6.1.1 连接线样式区分
- **电缆连接**：蓝色实线，线宽根据电流等级调整
- **铜排连接**：橙色粗线，表示大电流传输
- **母线连接**：绿色粗线，表示母线连接
- **并联连接**：双线或虚线表示
- **上下级关系**：箭头方向表示层级

#### 6.1.2 交互功能
- **连接线点击**：显示连接详细信息（包含熔丝、空开信息）
- **右键菜单**：编辑连接、删除连接
- **拖拽创建**：从源设备拖拽到目标设备创建连接
- **缩放和平移**：支持图形的缩放和平移操作
- **层级筛选**：按上下级关系筛选显示

### 6.2 连接管理界面

#### 6.2.1 连接列表页面
```html
<!-- 新增页面：/templates/connections.html -->
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <h2>供电连接管理</h2>
      
      <!-- 筛选和搜索 -->
      <div class="row mb-3">
        <div class="col-md-2">
          <select class="form-select" id="connectionTypeFilter">
            <option value="">所有连接类型</option>
            <option value="cable">电缆连接</option>
            <option value="busbar">铜排连接</option>
            <option value="busway">母线连接</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="hierarchyFilter">
            <option value="">所有层级关系</option>
            <option value="A上B下">A上B下</option>
            <option value="A下B上">A下B上</option>
            <option value="平级">平级</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="upstreamFilter">
            <option value="">所有上下游</option>
            <option value="上游">上游</option>
            <option value="下游">下游</option>
            <option value="中游">中游</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" id="deviceSearch" placeholder="搜索设备名称">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary" onclick="addConnection()">新增连接</button>
          <button class="btn btn-success" onclick="importFromExcel()">Excel导入</button>
        </div>
      </div>
      
      <!-- 连接列表表格 -->
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>源设备</th>
            <th>目标设备</th>
            <th>连接类型</th>
            <th>电缆型号</th>
            <th>熔丝/空开</th>
            <th>层级关系</th>
            <th>上下游</th>
            <th>并联数</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="connectionsTable">
          <!-- 动态加载 -->
        </tbody>
      </table>
      
      <!-- 分页 -->
      <nav>
        <ul class="pagination" id="pagination">
          <!-- 动态生成 -->
        </ul>
      </nav>
    </div>
  </div>
</div>
```

#### 6.2.2 连接编辑对话框
```html
<!-- 连接编辑模态框 -->
<div class="modal fade" id="connectionModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">编辑连接</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="connectionForm">
          <!-- 基础连接信息 -->
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">源设备 (A端)</label>
              <select class="form-select" name="source_device_id" required>
                <!-- 动态加载设备列表 -->
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">目标设备 (B端)</label>
              <select class="form-select" name="target_device_id" required>
                <!-- 动态加载设备列表 -->
              </select>
            </div>
          </div>
          
          <!-- A端信息 -->
          <h6 class="mt-4">A端信息</h6>
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">A端熔丝编号</label>
              <input type="text" class="form-control" name="source_fuse_number">
            </div>
            <div class="col-md-3">
              <label class="form-label">A端熔丝规格</label>
              <input type="text" class="form-control" name="source_fuse_spec">
            </div>
            <div class="col-md-3">
              <label class="form-label">A端空开编号</label>
              <input type="text" class="form-control" name="source_breaker_number">
            </div>
            <div class="col-md-3">
              <label class="form-label">A端空开规格</label>
              <input type="text" class="form-control" name="source_breaker_spec">
            </div>
          </div>
          
          <!-- B端信息 -->
          <h6 class="mt-4">B端信息</h6>
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">B端熔丝编号</label>
              <input type="text" class="form-control" name="target_fuse_number">
            </div>
            <div class="col-md-3">
              <label class="form-label">B端熔丝规格</label>
              <input type="text" class="form-control" name="target_fuse_spec">
            </div>
            <div class="col-md-3">
              <label class="form-label">B端空开编号</label>
              <input type="text" class="form-control" name="target_breaker_number">
            </div>
            <div class="col-md-3">
              <label class="form-label">B端空开规格</label>
              <input type="text" class="form-control" name="target_breaker_spec">
            </div>
          </div>
          
          <!-- 连接信息 -->
          <h6 class="mt-4">连接信息</h6>
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">连接类型</label>
              <select class="form-select" name="connection_type" required>
                <option value="cable">电缆连接</option>
                <option value="busbar">铜排连接</option>
                <option value="busway">母线连接</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">电缆型号</label>
              <input type="text" class="form-control" name="cable_model" placeholder="如：RVVZ-240mm²">
            </div>
            <div class="col-md-3">
              <label class="form-label">上下级关系</label>
              <select class="form-select" name="hierarchy_relation">
                <option value="">请选择</option>
                <option value="A上B下">A上B下</option>
                <option value="A下B上">A下B上</option>
                <option value="平级">平级</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">上下游关系</label>
              <select class="form-select" name="upstream_downstream">
                <option value="">请选择</option>
                <option value="上游">上游</option>
                <option value="下游">下游</option>
                <option value="中游">中游</option>
              </select>
            </div>
          </div>
          
          <!-- 技术参数 -->
          <h6 class="mt-4">技术参数</h6>
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">并联数量</label>
              <input type="number" class="form-control" name="parallel_count" value="1" min="1">
            </div>
            <div class="col-md-3">
              <label class="form-label">额定电流(A)</label>
              <input type="number" class="form-control" name="rated_current" step="0.1">
            </div>
            <div class="col-md-3">
              <label class="form-label">电缆长度(m)</label>
              <input type="number" class="form-control" name="cable_length" step="0.1">
            </div>
            <div class="col-md-3">
              <label class="form-label">安装日期</label>
              <input type="date" class="form-control" name="installation_date">
            </div>
          </div>
          
          <!-- 附加信息 -->
          <h6 class="mt-4">附加信息</h6>
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">B端设备位置</label>
              <input type="text" class="form-control" name="target_device_location">
            </div>
            <div class="col-md-6">
              <label class="form-label">备注</label>
              <textarea class="form-control" name="remark" rows="2"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveConnection()">保存</button>
      </div>
    </div>
  </div>
</div>
```

### 6.3 统计分析界面

#### 6.3.1 连接统计卡片
```html
<!-- 在首页添加连接统计 -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card text-white bg-info">
      <div class="card-body">
        <h6 class="card-title">总连接数</h6>
        <h3 id="totalConnections">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-primary">
      <div class="card-body">
        <h6 class="card-title">电缆连接</h6>
        <h3 id="cableConnections">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-warning">
      <div class="card-body">
        <h6 class="card-title">铜排连接</h6>
        <h3 id="busbarConnections">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-success">
      <div class="card-body">
        <h6 class="card-title">母线连接</h6>
        <h3 id="buswayConnections">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-danger">
      <div class="card-body">
        <h6 class="card-title">并联连接</h6>
        <h3 id="parallelConnections">-</h3>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-dark">
      <div class="card-body">
        <h6 class="card-title">总容量(A)</h6>
        <h3 id="totalCapacity">-</h3>
      </div>
    </div>
  </div>
</div>
```

#### 6.3.2 端口统计界面
```html
<!-- 端口统计概览卡片 -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-white bg-primary">
      <div class="card-body">
        <h6 class="card-title">总端口数</h6>
        <h3 id="totalPorts">-</h3>
        <small>设备总数: <span id="totalDevices">-</span></small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-success">
      <div class="card-body">
        <h6 class="card-title">已连接端口</h6>
        <h3 id="connectedPorts">-</h3>
        <small>利用率: <span id="utilizationRate">-</span>%</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-warning">
      <div class="card-body">
        <h6 class="card-title">空闲端口</h6>
        <h3 id="idlePorts">-</h3>
        <small>可扩容端口数</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-info">
      <div class="card-body">
        <h6 class="card-title">大容量可用</h6>
        <h3 id="highCapacityAvailable">-</h3>
        <small>≥400A空闲端口</small>
      </div>
    </div>
  </div>
</div>

<!-- 端口类型统计 -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-plug"></i> 端口类型统计</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-primary" id="fusePorts">-</h4>
              <p class="mb-1">熔丝端口</p>
              <small class="text-muted">利用率: <span id="fuseUtilization">-</span>%</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-success" id="breakerPorts">-</h4>
              <p class="mb-1">空开端口</p>
              <small class="text-muted">利用率: <span id="breakerUtilization">-</span>%</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> 容量分布统计</h5>
      </div>
      <div class="card-body">
        <div id="capacityChart" style="height: 200px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- 容量统计表格 -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-table"></i> 各容量端口使用情况</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>容量等级</th>
                <th>总端口数</th>
                <th>已连接</th>
                <th>空闲</th>
                <th>利用率</th>
                <th>状态</th>
              </tr>
            </thead>
            <tbody id="capacityStatsTable">
              <!-- 动态生成容量统计行 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 设备端口详情表格 -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-server"></i> 设备端口使用详情</h5>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="exportPortStatistics()">
            <i class="fas fa-download"></i> 导出统计
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="refreshPortStatistics()">
            <i class="fas fa-sync-alt"></i> 刷新
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>设备名称</th>
                <th>总端口</th>
                <th>已连接</th>
                <th>空闲</th>
                <th>利用率</th>
                <th>熔丝端口</th>
                <th>空开端口</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="devicePortDetailsTable">
              <!-- 动态生成设备端口详情行 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
```

#### 6.3.3 端口统计JavaScript函数
```javascript
// 端口统计相关函数
class PortStatisticsManager {
    constructor() {
        this.statisticsData = null;
    }

    // 加载端口统计数据
    async loadPortStatistics() {
        try {
            const response = await fetch('/api/ports/statistics');
            if (!response.ok) {
                throw new Error('获取端口统计数据失败');
            }
            this.statisticsData = await response.json();
            this.renderPortStatistics();
        } catch (error) {
            console.error('加载端口统计失败:', error);
            showAlert('加载端口统计数据失败', 'danger');
        }
    }

    // 渲染端口统计界面
    renderPortStatistics() {
        if (!this.statisticsData) return;

        const { device_port_summary, port_type_statistics, capacity_statistics, device_port_details } = this.statisticsData;

        // 更新概览卡片
        this.updateOverviewCards(device_port_summary);
        
        // 更新端口类型统计
        this.updatePortTypeStatistics(port_type_statistics);
        
        // 更新容量统计表格
        this.updateCapacityTable(capacity_statistics.by_rating);
        
        // 更新设备端口详情表格
        this.updateDevicePortTable(device_port_details);
        
        // 渲染容量分布图表
        this.renderCapacityChart(capacity_statistics.by_rating);
    }

    // 更新概览卡片
    updateOverviewCards(summary) {
        document.getElementById('totalPorts').textContent = summary.total_ports;
        document.getElementById('totalDevices').textContent = summary.total_devices;
        document.getElementById('connectedPorts').textContent = summary.connected_ports;
        document.getElementById('utilizationRate').textContent = summary.utilization_rate.toFixed(1);
        document.getElementById('idlePorts').textContent = summary.idle_ports;
        
        // 更新大容量可用端口数
        const highCapacity = this.statisticsData.capacity_statistics.high_capacity_available['400A_above'] || 0;
        document.getElementById('highCapacityAvailable').textContent = highCapacity;
    }

    // 更新端口类型统计
    updatePortTypeStatistics(portTypes) {
        document.getElementById('fusePorts').textContent = portTypes.fuse_ports.total;
        document.getElementById('fuseUtilization').textContent = portTypes.fuse_ports.utilization_rate.toFixed(1);
        document.getElementById('breakerPorts').textContent = portTypes.breaker_ports.total;
        document.getElementById('breakerUtilization').textContent = portTypes.breaker_ports.utilization_rate.toFixed(1);
    }

    // 更新容量统计表格
    updateCapacityTable(capacityData) {
        const tableBody = document.getElementById('capacityStatsTable');
        tableBody.innerHTML = '';

        Object.entries(capacityData).forEach(([rating, stats]) => {
            const utilizationRate = (stats.connected / stats.total * 100).toFixed(1);
            const statusClass = this.getCapacityStatusClass(parseFloat(utilizationRate));
            const statusText = this.getCapacityStatusText(parseFloat(utilizationRate));

            const row = `
                <tr>
                    <td><strong>${rating}</strong></td>
                    <td>${stats.total}</td>
                    <td><span class="text-success">${stats.connected}</span></td>
                    <td><span class="text-warning">${stats.idle}</span></td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${statusClass}" role="progressbar" 
                                 style="width: ${utilizationRate}%" 
                                 aria-valuenow="${utilizationRate}" aria-valuemin="0" aria-valuemax="100">
                                ${utilizationRate}%
                            </div>
                        </div>
                    </td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // 更新设备端口详情表格
    updateDevicePortTable(deviceDetails) {
        const tableBody = document.getElementById('devicePortDetailsTable');
        tableBody.innerHTML = '';

        deviceDetails.forEach(device => {
            const utilizationClass = this.getUtilizationClass(device.utilization_rate);
            const row = `
                <tr>
                    <td><strong>${device.device_name}</strong></td>
                    <td>${device.total_ports}</td>
                    <td><span class="text-success">${device.connected_ports}</span></td>
                    <td><span class="text-warning">${device.idle_ports}</span></td>
                    <td>
                        <span class="badge ${utilizationClass}">${device.utilization_rate.toFixed(1)}%</span>
                    </td>
                    <td>${device.port_breakdown.fuse_ports.total} (${device.port_breakdown.fuse_ports.connected}/${device.port_breakdown.fuse_ports.idle})</td>
                    <td>${device.port_breakdown.breaker_ports.total} (${device.port_breakdown.breaker_ports.connected}/${device.port_breakdown.breaker_ports.idle})</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewDevicePortDetails('${device.device_name}')">
                            <i class="fas fa-eye"></i> 详情
                        </button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // 获取容量状态样式类
    getCapacityStatusClass(utilizationRate) {
        if (utilizationRate >= 90) return 'bg-danger';
        if (utilizationRate >= 70) return 'bg-warning';
        if (utilizationRate >= 50) return 'bg-info';
        return 'bg-success';
    }

    // 获取容量状态文本
    getCapacityStatusText(utilizationRate) {
        if (utilizationRate >= 90) return '接近满载';
        if (utilizationRate >= 70) return '负载较高';
        if (utilizationRate >= 50) return '负载适中';
        return '负载较低';
    }

    // 获取利用率样式类
    getUtilizationClass(utilizationRate) {
        if (utilizationRate >= 90) return 'badge bg-danger';
        if (utilizationRate >= 70) return 'badge bg-warning';
        if (utilizationRate >= 50) return 'badge bg-info';
        return 'badge bg-success';
    }

    // 渲染容量分布图表（使用Chart.js）
    renderCapacityChart(capacityData) {
        const ctx = document.getElementById('capacityChart');
        if (!ctx) return;

        const labels = Object.keys(capacityData);
        const connectedData = labels.map(rating => capacityData[rating].connected);
        const idleData = labels.map(rating => capacityData[rating].idle);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '已连接',
                        data: connectedData,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '空闲',
                        data: idleData,
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true
                    },
                    x: {
                        stacked: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '各容量端口使用分布'
                    }
                }
            }
        });
    }
}

// 全局端口统计管理器实例
const portStatsManager = new PortStatisticsManager();

// 导出端口统计数据
function exportPortStatistics() {
    if (!portStatsManager.statisticsData) {
        showAlert('没有可导出的统计数据', 'warning');
        return;
    }
    
    // 实现导出功能
    const dataStr = JSON.stringify(portStatsManager.statisticsData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `port_statistics_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

// 刷新端口统计
function refreshPortStatistics() {
    portStatsManager.loadPortStatistics();
}

// 查看设备端口详情
function viewDevicePortDetails(deviceName) {
    // 实现设备端口详情查看功能
    console.log('查看设备端口详情:', deviceName);
    // 可以打开模态框显示详细的端口信息
}
```

## 7. UI/UX设计规范

### 7.1 整体设计风格

基于现有系统分析，设备连接关系模块必须与现有的设备管理和生命周期管理模块保持完全一致的视觉风格。

#### 7.1.1 设计系统概览

**现有系统特征：**
- **技术栈**：Bootstrap 5.1.3 + Font Awesome 6.0.0
- **主色调**：蓝色系（#007bff, #4a69bd）
- **字体**：'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
- **布局**：响应式设计，container-fluid布局
- **组件风格**：现代扁平化设计，圆角边框，阴影效果

#### 7.1.2 色彩规范

**主色调：**
- 主蓝色：`#007bff` (Bootstrap Primary)
- 深蓝色：`#4a69bd` (表头背景)
- 导航栏：`bg-primary` (Bootstrap)

**状态色彩：**
- 成功/正常：`#28a745` (绿色)
- 警告：`#ffc107` (黄色)
- 危险/过期：`#dc3545` (红色)
- 信息：`#17a2b8` (青色)
- 次要：`#6c757d` (灰色)

**背景色彩：**
- 页面背景：`#f8f9fa`
- 卡片背景：`#ffffff`
- 表格斑马纹：`#e9ecef`
- 悬停效果：`#007bff`

#### 7.1.3 字体规范

**字体族：**
```css
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
```

**字体大小：**
- 页面标题(h1)：默认Bootstrap大小
- 模块标题(h2)：默认Bootstrap大小
- 表头：14px, 大写, 字母间距0.5px
- 正文：默认Bootstrap大小
- 小标签：12px

**字体颜色：**
- 主文本：`#333`
- 标题：`#2c3e50`
- 次要文本：`#6c757d` (text-muted)
- 表头：`#ffffff`

### 7.2 导航栏设计规范

#### 7.2.1 导航栏结构
```html
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="fas fa-bolt"></i> 安吉电信动力设备管理系统
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/">设备管理</a>
            <a class="nav-link active" href="/connections">连接管理</a>
            <a class="nav-link" href="/lifecycle-management">生命周期管理</a>
        </div>
    </div>
</nav>
```

**设计要点：**
- 使用Bootstrap `navbar-dark bg-primary`
- 品牌logo使用闪电图标 `fas fa-bolt`
- 导航链接右对齐 `ms-auto`
- 当前页面使用 `active` 类高亮

### 7.3 页面布局规范

#### 7.3.1 页面容器
```html
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-project-diagram"></i> 设备连接管理</h2>
            <p class="text-muted">管理设备间的供电连接关系，支持电缆、铜排、母线连接的可视化和管理</p>
        </div>
    </div>
    <!-- 页面内容 -->
</div>
```

**布局特点：**
- 使用 `container-fluid` 全宽布局
- 顶部间距 `mt-4`
- 页面标题使用图标 + 文字
- 副标题使用 `text-muted` 样式

### 7.4 表格设计规范

#### 7.4.1 表格样式
```css
/* 表头样式 */
.table thead th {
    background-color: #4a69bd !important;
    color: #ffffff !important;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 14px;
    letter-spacing: 0.5px;
    white-space: nowrap;
    border-color: #4a69bd !important;
}

/* 表头分隔线 */
thead th:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 20%;
    height: 60%;
    width: 1px;
    background-color: rgba(255, 255, 255, 0.3);
}

/* 斑马纹和悬停效果 */
tbody tr:nth-of-type(even) {
    background-color: #e9ecef;
}

tbody tr:hover {
    background-color: #007bff;
    color: #ffffff;
}
```

### 7.5 按钮和表单规范

#### 7.5.1 按钮样式
**主要按钮：**
```html
<button class="btn btn-primary">新增连接</button>
<button class="btn btn-success">Excel导入</button>
<button class="btn btn-info">导出数据</button>
```

**次要按钮：**
```html
<button class="btn btn-outline-primary">筛选</button>
<button class="btn btn-outline-secondary">重置</button>
```

**危险操作：**
```html
<button class="btn btn-danger">删除</button>
<button class="btn btn-outline-danger">批量删除</button>
```

#### 7.5.2 表单控件
```html
<!-- 下拉选择 -->
<select class="form-select">
    <option value="">请选择...</option>
</select>

<!-- 文本输入 -->
<input type="text" class="form-control" placeholder="请输入...">

<!-- 搜索框 -->
<input type="text" class="form-control" placeholder="搜索设备名称">
```

### 7.6 状态标签规范

#### 7.6.1 连接类型标签
```css
.connection-type-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    display: inline-block;
    min-width: 60px;
}

.connection-cable {
    background-color: #cce5ff;
    color: #0056b3;
    border: 1px solid #99d6ff;
}

.connection-busbar {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.connection-busway {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
```

#### 7.6.2 层级关系标签
```css
.hierarchy-badge {
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 500;
}

.hierarchy-upstream {
    background-color: #e3f2fd;
    color: #1565c0;
}

.hierarchy-downstream {
    background-color: #f3e5f5;
    color: #7b1fa2;
}

.hierarchy-parallel {
    background-color: #e8f5e8;
    color: #2e7d32;
}
```

### 7.7 拓扑图可视化设计规范

#### 7.7.1 图形容器样式
```css
#connectionTopology {
    width: 100%;
    height: 70vh;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
    position: relative;
}

/* 拓扑图工具栏 */
.topology-toolbar {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 6px;
    padding: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.topology-toolbar .btn {
    margin: 0 2px;
    padding: 4px 8px;
    font-size: 12px;
}
```

#### 7.7.2 节点样式规范
```javascript
// vis.js节点配置
const nodeStyles = {
    // 设备节点基础样式
    default: {
        shape: 'box',
        margin: 10,
        font: {
            size: 14,
            color: '#2c3e50',
            face: 'Segoe UI'
        },
        borderWidth: 2,
        borderWidthSelected: 3
    },
    
    // 不同设备类型的颜色
    deviceTypes: {
        '直流配电屏': {
            color: {
                background: '#e3f2fd',
                border: '#1976d2',
                highlight: { background: '#bbdefb', border: '#0d47a1' }
            }
        },
        '蓄电池': {
            color: {
                background: '#e8f5e8',
                border: '#388e3c',
                highlight: { background: '#c8e6c9', border: '#1b5e20' }
            }
        },
        '整流器': {
            color: {
                background: '#fff3e0',
                border: '#f57c00',
                highlight: { background: '#ffe0b2', border: '#e65100' }
            }
        }
    }
};
```

#### 7.7.3 连接线样式规范
```javascript
// vis.js边样式配置
const edgeStyles = {
    // 电缆连接
    cable: {
        color: {
            color: '#2196f3',
            highlight: '#1976d2',
            hover: '#42a5f5'
        },
        width: 3,
        dashes: false,
        arrows: { to: { enabled: true, scaleFactor: 1.2 } }
    },
    
    // 铜排连接
    busbar: {
        color: {
            color: '#ff9800',
            highlight: '#f57c00',
            hover: '#ffb74d'
        },
        width: 5,
        dashes: false,
        arrows: { to: { enabled: true, scaleFactor: 1.5 } }
    },
    
    // 母线连接
    busway: {
        color: {
            color: '#4caf50',
            highlight: '#388e3c',
            hover: '#66bb6a'
        },
        width: 6,
        dashes: false,
        arrows: { to: { enabled: true, scaleFactor: 1.8 } }
    },
    
    // 并联连接
    parallel: {
        dashes: [5, 5],
        width: 2
    }
};
```

#### 7.7.4 交互设计规范

**鼠标交互：**
- **悬停节点**：显示设备详细信息tooltip
- **点击节点**：高亮显示相关连接
- **双击节点**：跳转到设备详情页
- **右键节点**：显示上下文菜单（编辑、删除、查看连接）

**连接线交互：**
- **悬停连接线**：显示连接详细信息（电缆型号、规格、电流等）
- **点击连接线**：高亮显示，侧边栏显示详细信息
- **右键连接线**：显示编辑/删除菜单

**工具栏功能：**
```html
<div class="topology-toolbar">
    <button class="btn btn-sm btn-outline-primary" title="适应窗口">
        <i class="fas fa-expand-arrows-alt"></i>
    </button>
    <button class="btn btn-sm btn-outline-primary" title="重置视图">
        <i class="fas fa-home"></i>
    </button>
    <button class="btn btn-sm btn-outline-primary" title="全屏">
        <i class="fas fa-expand"></i>
    </button>
    <button class="btn btn-sm btn-outline-success" title="导出图片">
        <i class="fas fa-download"></i>
    </button>
</div>
```

### 7.8 响应式设计规范

#### 7.8.1 断点设置
遵循Bootstrap 5断点：
- **xs**: <576px
- **sm**: ≥576px
- **md**: ≥768px
- **lg**: ≥992px
- **xl**: ≥1200px
- **xxl**: ≥1400px

#### 7.8.2 移动端适配
```css
/* 移动端拓扑图适配 */
@media (max-width: 768px) {
    #connectionTopology {
        height: 50vh;
    }
    
    .topology-toolbar {
        position: static;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .connection-table {
        font-size: 12px;
    }
    
    .connection-table th,
    .connection-table td {
        padding: 6px 4px;
    }
}
```

### 7.9 无障碍设计规范

#### 7.9.1 键盘导航
- 所有交互元素支持Tab键导航
- 拓扑图支持方向键移动焦点
- Enter键激活选中元素
- Escape键关闭模态框和菜单

#### 7.9.2 屏幕阅读器支持
```html
<!-- ARIA标签示例 -->
<button class="btn btn-primary" aria-label="新增设备连接">
    <i class="fas fa-plus" aria-hidden="true"></i> 新增连接
</button>

<div id="connectionTopology" role="img" aria-label="设备连接拓扑图">
    <!-- 拓扑图内容 -->
</div>
```

#### 7.9.3 色彩对比度
确保所有文本和背景的对比度符合WCAG 2.1 AA标准（4.5:1）。

### 7.10 动画和过渡效果

#### 7.10.1 页面过渡
```css
/* 页面加载动画 */
.page-transition {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease-in-out;
}

.page-transition.loaded {
    opacity: 1;
    transform: translateY(0);
}

/* 卡片悬停效果 */
.statistics-card {
    transition: all 0.3s ease;
}

.statistics-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
```

#### 7.10.2 拓扑图动画
```javascript
// vis.js动画配置
const animationOptions = {
    animation: {
        duration: 1000,
        easingFunction: 'easeInOutQuad'
    },
    physics: {
        stabilization: {
            enabled: true,
            iterations: 1000,
            updateInterval: 25
        }
    }
};
```

### 7.11 设计一致性检查清单

**导航和布局：**
- [ ] 导航栏使用统一的 `navbar-dark bg-primary` 样式
- [ ] 页面标题使用图标 + 文字格式
- [ ] 使用 `container-fluid mt-4` 布局
- [ ] 副标题使用 `text-muted` 样式

**表格和列表：**
- [ ] 表头使用 `#4a69bd` 背景色
- [ ] 表格支持斑马纹和悬停效果
- [ ] 操作按钮使用Bootstrap标准样式

**表单和控件：**
- [ ] 使用Bootstrap表单控件类
- [ ] 按钮颜色符合语义化设计
- [ ] 状态标签使用统一的样式规范

**拓扑图可视化：**
- [ ] 容器使用渐变背景和圆角边框
- [ ] 节点颜色按设备类型区分
- [ ] 连接线样式按连接类型区分
- [ ] 工具栏使用半透明背景

**响应式和无障碍：**
- [ ] 移动端适配正常
- [ ] 支持键盘导航
- [ ] ARIA标签完整
- [ ] 色彩对比度符合标准

通过严格遵循这些UI/UX设计规范，确保设备连接关系模块与现有系统保持完美的视觉一致性，同时为拓扑图可视化提供直观、美观且易用的交互体验。

## 7. 数据迁移策略

### 7.1 数据库迁移方案

```python
# 数据库迁移脚本：migrate_connections.py
import sqlite3
from datetime import datetime

def upgrade_connection_table():
    """升级Connection表结构"""
    conn = sqlite3.connect('asset_management.db')
    cursor = conn.cursor()
    
    try:
        # 备份现有数据
        cursor.execute("CREATE TABLE connections_backup AS SELECT * FROM connections")
        
        # 添加新字段
        new_columns = [
            "source_fuse_number VARCHAR(50)",
            "source_fuse_spec VARCHAR(100)",
            "source_breaker_number VARCHAR(50)",
            "source_breaker_spec VARCHAR(100)",
            "target_fuse_number VARCHAR(50)",
            "target_fuse_spec VARCHAR(100)",
            "target_breaker_number VARCHAR(50)",
            "target_breaker_spec VARCHAR(100)",
            "target_device_location VARCHAR(200)",
            "connection_type VARCHAR(20) DEFAULT 'cable'",
            "cable_model VARCHAR(100)",
            "hierarchy_relation VARCHAR(20)",
            "upstream_downstream VARCHAR(20)",
            "cable_specification VARCHAR(100)",
            "parallel_count INTEGER DEFAULT 1",
            "rated_current FLOAT",
            "cable_length FLOAT",
            "source_device_photo VARCHAR(500)",
            "target_device_photo VARCHAR(500)",
            "remark TEXT",
            "installation_date DATE",
            "created_at DATETIME DEFAULT CURRENT_TIMESTAMP",
            "updated_at DATETIME DEFAULT CURRENT_TIMESTAMP"
        ]
        
        for column in new_columns:
            try:
                cursor.execute(f"ALTER TABLE connections ADD COLUMN {column}")
                print(f"添加字段成功: {column}")
            except sqlite3.OperationalError as e:
                if "duplicate column name" in str(e):
                    print(f"字段已存在，跳过: {column}")
                else:
                    raise e
        
        # 迁移现有数据
        cursor.execute("""
            UPDATE connections 
            SET connection_type = CASE 
                WHEN cable_type LIKE '%电缆%' THEN 'cable'
                WHEN cable_type LIKE '%铜排%' THEN 'busbar'
                WHEN cable_type LIKE '%母线%' THEN 'busway'
                ELSE 'cable'
            END
            WHERE cable_type IS NOT NULL
        """)
        
        cursor.execute("""
            UPDATE connections 
            SET cable_specification = cable_type 
            WHERE cable_type IS NOT NULL
        """)
        
        conn.commit()
        print("数据库迁移完成")
        
    except Exception as e:
        conn.rollback()
        print(f"数据库迁移失败: {e}")
        # 恢复备份
        cursor.execute("DROP TABLE IF EXISTS connections")
        cursor.execute("ALTER TABLE connections_backup RENAME TO connections")
        conn.commit()
        raise e
    
    finally:
        conn.close()

if __name__ == "__main__":
    upgrade_connection_table()
```

### 7.2 Excel数据导入增强

```python
# Excel导入增强脚本
import pandas as pd
import re
from datetime import datetime

def parse_parallel_count(remark):
    """从备注中解析并联数量"""
    if not remark or pd.isna(remark):
        return 1
    
    # 匹配类似 "A、B间电缆*4" 的模式
    match = re.search(r'电缆\*(\d+)', str(remark))
    if match:
        return int(match.group(1))
    
    # 匹配类似 "A端熔丝*2" 的模式
    match = re.search(r'熔丝\*(\d+)', str(remark))
    if match:
        return int(match.group(1))
    
    return 1

def parse_rated_current(spec):
    """从规格中解析额定电流"""
    if not spec or pd.isna(spec):
        return None
    
    # 匹配类似 "NT4(500A)" 或 "RT16Z-3(500A)" 的模式
    match = re.search(r'\((\d+)A\)', str(spec))
    if match:
        return float(match.group(1))
    
    return None

def standardize_connection_type(conn_type):
    """标准化连接类型"""
    if not conn_type or pd.isna(conn_type):
        return 'cable'
    
    conn_type = str(conn_type).strip()
    if '电缆' in conn_type:
        return 'cable'
    elif '铜排' in conn_type:
        return 'busbar'
    elif '母线' in conn_type:
        return 'busway'
    else:
        return 'cable'

def import_connections_from_excel(excel_path, db_session):
    """从Excel导入连接数据"""
    # 读取连接表
    df = pd.read_excel(excel_path, sheet_name=1)
    
    imported_count = 0
    error_count = 0
    
    for index, row in df.iterrows():
        try:
            # 查找设备ID
            source_device = db_session.query(Device).filter(
                Device.name == row['A端设备名称']
            ).first()
            
            target_device = db_session.query(Device).filter(
                Device.name == row['B端设备名称']
            ).first()
            
            if not source_device or not target_device:
                print(f"第{index+1}行：设备不存在，跳过")
                error_count += 1
                continue
            
            # 检查重复连接
            existing = db_session.query(Connection).filter(
                Connection.source_device_id == source_device.id,
                Connection.target_device_id == target_device.id,
                Connection.source_fuse_number == row.get('A端熔丝编号'),
                Connection.target_fuse_number == row.get('B端熔丝编号')
            ).first()
            
            if existing:
                print(f"第{index+1}行：连接已存在，跳过")
                continue
            
            # 创建连接记录
            connection = Connection(
                source_device_id=source_device.id,
                target_device_id=target_device.id,
                source_fuse_number=row.get('A端熔丝编号'),
                source_fuse_spec=row.get('A端熔丝规格'),
                source_breaker_number=row.get('A端空开编号'),
                source_breaker_spec=row.get('A端空开规格'),
                target_fuse_number=row.get('B端熔丝编号'),
                target_fuse_spec=row.get('B端熔丝规格'),
                target_breaker_number=row.get('B端空开编号'),
                target_breaker_spec=row.get('空开规格'),
                target_device_location=row.get('B端设备位置（非动力设备）'),
                connection_type=standardize_connection_type(row.get('连接类型（电缆 / 铜排 / 母线）')),
                cable_model=row.get('电缆型号'),
                hierarchy_relation=row.get('上下级'),
                upstream_downstream=row.get('上下游'),
                parallel_count=parse_parallel_count(row.get('备注')),
                rated_current=parse_rated_current(row.get('A端熔丝规格')) or parse_rated_current(row.get('A端空开规格')),
                source_device_photo=row.get('A端设备照片'),
                target_device_photo=row.get('B端设备照片'),
                remark=row.get('备注'),
                created_at=datetime.utcnow()
            )
            
            db_session.add(connection)
            imported_count += 1
            
        except Exception as e:
            print(f"第{index+1}行导入失败: {e}")
            error_count += 1
    
    try:
        db_session.commit()
        print(f"导入完成：成功{imported_count}条，失败{error_count}条")
    except Exception as e:
        db_session.rollback()
        print(f"批量提交失败: {e}")
        raise e
    
    return imported_count, error_count
```

## 8. 性能优化策略

### 8.1 数据库性能优化

```sql
-- 创建索引提升查询性能
CREATE INDEX idx_connection_source ON connections(source_device_id);
CREATE INDEX idx_connection_target ON connections(target_device_id);
CREATE INDEX idx_connection_type ON connections(connection_type);
CREATE INDEX idx_connection_hierarchy ON connections(hierarchy_relation);
CREATE INDEX idx_connection_upstream ON connections(upstream_downstream);
CREATE INDEX idx_connection_devices ON connections(source_device_id, target_device_id);
CREATE INDEX idx_connection_created ON connections(created_at);
```

### 8.2 前端性能优化

**拓扑图优化：**
- 大图数据分批加载
- 节点聚合显示
- 视口裁剪优化
- 防抖处理用户交互

**页面加载优化：**
- 懒加载非关键资源
- 压缩JavaScript和CSS
- 使用CDN加载第三方库
- 分页查询避免大数据量加载

## 9. 风险评估与缓解

### 9.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 数据迁移失败 | 低 | 高 | 完整备份、分步迁移、回滚方案 |
| 性能下降 | 中 | 中 | 性能测试、索引优化、分页加载 |
| 前端兼容性 | 低 | 中 | 渐进增强、向后兼容、充分测试 |
| Excel导入错误 | 中 | 中 | 数据验证、错误处理、批量回滚 |

### 9.2 业务风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 用户接受度 | 低 | 中 | 用户培训、界面友好、功能渐进 |
| 数据准确性 | 中 | 高 | 数据验证、审核流程、错误检测 |
| 字段映射错误 | 中 | 高 | 详细测试、字段验证、数据对比 |

## 10. 实施计划

### 10.1 分阶段实施

**第一阶段：基础修复（1-2天）**
- [ ] 修复API路径不匹配问题
- [ ] 扩展Connection数据模型
- [ ] 创建数据库迁移脚本
- [ ] 实现基础CRUD API接口

**第二阶段：管理界面（2-3天）**
- [ ] 开发连接管理页面
- [ ] 实现连接列表和筛选功能
- [ ] 开发连接编辑对话框
- [ ] 数据验证和错误处理

**第三阶段：可视化增强（2-3天）**
- [ ] 优化拓扑图连接线样式
- [ ] 增强交互功能
- [ ] 添加层级关系显示
- [ ] 性能优化

**第四阶段：Excel导入增强（1-2天）**
- [ ] 增强Excel数据导入功能
- [ ] 数据验证和清理
- [ ] 错误处理和回滚
- [ ] 导入结果统计

**第五阶段：测试和优化（1-2天）**
- [ ] 全面功能测试
- [ ] 性能测试和优化
- [ ] 用户体验优化
- [ ] 文档更新

### 10.2 成功关键因素

#### 技术实施关键因素
- **渐进式增强策略**：确保每个阶段都有可交付的成果
- **向后兼容保证**：新功能不影响现有系统运行
- **完整的数据迁移方案**：确保数据安全和完整性
- **分阶段实施计划**：降低实施风险，便于问题定位
- **风险评估与缓解**：提前识别和应对潜在风险

#### 团队协作关键因素
- **明确的沟通机制**：确保团队成员对需求和进度有共同理解
- **代码审查制度**：保证代码质量和知识共享
- **文档同步更新**：确保文档与实际实现保持一致
- **测试驱动开发**：通过测试确保功能正确性

#### 质量保证关键因素
- **全面的测试覆盖**：单元测试、集成测试、用户验收测试
- **性能监控机制**：确保系统性能满足要求
- **用户反馈收集**：及时收集和响应用户反馈
- **持续改进机制**：基于使用情况持续优化系统

### 10.3 开发规则与流程控制

#### 核心开发规则
- **阶段性确认制**：每实现一个新功能或阶段性成果，必须经过用户测试确认无误后才能进行下一步
- **严格遵循设计文档**：后续开发必须严格按照本综合设计文档执行，确保高成功率
- **Git提交管理**：重要节点及时进行Git提交，不要等到最后一次性提交
- **错误和经验记录**：开发过程中的重要错误、经验和重要操作都要单独记录到文档中
- **Bug修复流程**：修复Bug前先全面检查相关文件，给出分析诊断报告，确认后再修改
- **回退准备**：修改时要做好回退准备，如造成新故障要能马上回退到之前状态

#### 质量控制标准
- **代码注释要求**：由于用户编程基础有限，必要地方要加详细注释
- **高标准严要求**：按照年薪过百万的超级高手标准，代码要精简高效
- **大局观思维**：要了解项目目标、范围、用户和stakeholders，避免局部优化导致整体问题
- **向后兼容**：新功能不能影响现有系统的正常运行

#### 文档管理规则
- **实时更新**：项目进行中如有变更，及时更新设计文档
- **经验总结**：重要的错误和经验要单独记录，作为后续参考
- **用户文档**：完成后要编写用户文档和操作指南

#### 测试确认流程
每个阶段完成后的测试确认包括：
1. **功能测试**：验证新功能是否按设计要求正常工作
2. **兼容性测试**：确保新功能不影响现有功能
3. **性能测试**：验证系统性能是否满足要求
4. **用户体验测试**：确保界面美观、操作便捷
5. **数据完整性测试**：确保数据迁移和处理的正确性

只有通过全部测试确认后，才能进入下一个开发阶段。

### 10.4 验收标准

**功能验收：**
- ✅ 支持Excel数据完整导入
- ✅ 连接CRUD操作正常
- ✅ 拓扑图正确显示连接关系
- ✅ 筛选和搜索功能正常
- ✅ 统计分析数据准确

**性能验收：**
- ✅ 页面加载时间 < 3秒
- ✅ 拓扑图渲染时间 < 5秒
- ✅ 连接列表查询时间 < 2秒
- ✅ Excel导入处理时间合理

**兼容性验收：**
- ✅ 现有设备管理功能不受影响
- ✅ 现有拓扑图功能正常
- ✅ 数据库结构向后兼容

## 11. 总结

本综合设计文档整合了技术方案分析和详细设计，确保了与Excel数据结构的完全兼容性。通过渐进式增强策略，在保持系统稳定性的前提下，实现了完整的设备连接关系管理功能。

**核心优势：**
- 📊 **数据完整性**：支持Excel中所有18个字段的完整映射
- 🔄 **向后兼容**：不影响现有功能，平滑升级
- 🎯 **业务匹配**：完全符合实际业务需求
- 🚀 **技术先进**：采用现代Web技术栈
- 📈 **可扩展性**：为未来功能扩展预留空间

**预期收益：**
- 提升设备连接关系管理效率
- 降低人工错误率和维护成本
- 支持决策分析和合规要求
- 提供直观的可视化展示
- 建立完善的数据管理体系

该方案已充分考虑了现有Excel数据结构，确保了设计阶段的完整性，避免了后期修修补补的问题。