# 动力设备拓扑图设计思路与实现方案

## 1. 项目背景与目标

### 1.1 项目背景
动力设备管理系统需要直观展示设备间的电力连接关系，帮助运维人员理解网络拓扑结构，快速定位故障影响范围，优化电力配置方案。当前系统已有基础的拓扑图实现，但功能相对简单，需要进一步完善和优化。

### 1.2 设计目标
- **直观性**：以图形化方式清晰展示设备连接关系
- **交互性**：提供丰富的用户交互功能，支持探索式分析
- **智能性**：集成分析算法，提供决策支持
- **性能性**：支持大规模网络的流畅展示和操作
- **扩展性**：模块化设计，便于功能扩展和定制

## 2. 现状分析

### 2.1 当前实现状况
- **独立页面**：`graph.html` 提供基础的拓扑图展示功能
- **集成标签页**：`connections.html` 中有拓扑图标签页但仅为占位符
- **后端API**：`get_graph_data` 和 `get_power_chain_data` 提供拓扑数据
- **可视化库**：使用 `vis.js` 进行图形渲染
- **算法实现**：基于BFS（广度优先搜索）构建设备连接图

### 2.2 存在的问题
- 功能分散，用户体验不统一
- 交互功能有限，缺乏高级分析能力
- 性能优化不足，大规模网络展示困难
- 缺乏智能分析和决策支持功能

## 3. 技术架构设计

### 3.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端展示层    │    │   业务逻辑层    │    │   数据存储层    │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 可视化组件    │    │ • 拓扑算法      │    │ • 设备数据      │
│ • 交互控制      │    │ • 路径分析      │    │ • 连接关系      │
│ • 工具栏       │    │ • 影响分析      │    │ • 历史记录      │
│ • 信息面板      │    │ • 缓存管理      │    │ • 配置信息      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 技术选型
- **前端框架**：基于现有的Bootstrap + JavaScript架构
- **可视化库**：vis.js（保持现有选择，但需要深度定制）
- **图算法**：Python + NetworkX（用于复杂图分析）
- **数据传输**：REST API + WebSocket（实时更新）
- **缓存策略**：Redis（可选，用于大规模部署）

## 4. 数据模型设计

### 4.1 节点数据结构
```json
{
  "id": "device_001",
  "label": "UPS-01",
  "type": "ups",
  "category": "power_supply",
  "status": "online",
  "properties": {
    "asset_number": "AS001",
    "model": "APC Smart-UPS 3000",
    "location": "机房A-01",
    "rated_power": 3000,
    "current_load": 1800,
    "importance_level": "critical",
    "install_date": "2023-01-15",
    "coordinates": {"x": 100, "y": 200}
  },
  "visual": {
    "shape": "box",
    "color": "#4CAF50",
    "size": 30,
    "icon": "fas fa-battery-full",
    "border_width": 2
  }
}
```

### 4.2 边数据结构
```json
{
  "id": "conn_001",
  "from": "device_001",
  "to": "device_002",
  "type": "power_cable",
  "direction": "bidirectional",
  "properties": {
    "cable_type": "电缆",
    "power_type": "AC",
    "specification": "YJV-4×95",
    "rated_current": 200,
    "length": 50,
    "install_date": "2023-01-20",
    "parallel_count": 1
  },
  "visual": {
    "color": "#FF9800",
    "gradient": ["#FFEB3B", "#4CAF50", "#F44336"],
    "width": 3,
    "style": "solid",
    "arrows": {"to": true}
  }
}
```

## 5. 算法设计

### 5.1 拓扑构建算法
```python
def build_topology(center_device_id, max_depth=3, filter_criteria=None):
    """
    构建以指定设备为中心的拓扑图
    
    Args:
        center_device_id: 中心设备ID
        max_depth: 最大搜索深度
        filter_criteria: 筛选条件
    
    Returns:
        dict: 包含nodes和edges的拓扑数据
    """
    visited = set()
    nodes = []
    edges = []
    queue = [(center_device_id, 0)]  # (device_id, depth)
    
    while queue:
        device_id, depth = queue.pop(0)
        
        if device_id in visited or depth > max_depth:
            continue
            
        visited.add(device_id)
        
        # 获取设备信息并添加到节点列表
        device = get_device_info(device_id)
        if device and passes_filter(device, filter_criteria):
            nodes.append(format_node(device, depth))
            
            # 获取连接的设备
            connections = get_device_connections(device_id)
            for conn in connections:
                target_id = conn.get_other_device_id(device_id)
                if target_id not in visited:
                    queue.append((target_id, depth + 1))
                    edges.append(format_edge(conn))
    
    return {"nodes": nodes, "edges": edges}
```

### 5.2 路径分析算法
```python
def find_all_paths(source_id, target_id, max_paths=10):
    """
    查找两个设备间的所有可能路径
    
    Args:
        source_id: 源设备ID
        target_id: 目标设备ID
        max_paths: 最大路径数量
    
    Returns:
        list: 路径列表，每个路径包含设备序列和连接信息
    """
    graph = build_network_graph()
    paths = list(nx.all_simple_paths(graph, source_id, target_id, cutoff=10))
    
    # 按路径长度和重要性排序
    scored_paths = []
    for path in paths[:max_paths]:
        score = calculate_path_score(path)
        scored_paths.append({
            "path": path,
            "score": score,
            "length": len(path),
            "reliability": calculate_reliability(path)
        })
    
    return sorted(scored_paths, key=lambda x: x["score"], reverse=True)
```

### 5.3 影响分析算法
```python
def analyze_failure_impact(failed_device_id):
    """
    分析设备故障的影响范围
    
    Args:
        failed_device_id: 故障设备ID
    
    Returns:
        dict: 影响分析结果
    """
    graph = build_network_graph()
    
    # 移除故障设备
    graph.remove_node(failed_device_id)
    
    # 分析连通性变化
    components = list(nx.connected_components(graph))
    isolated_devices = []
    affected_paths = []
    
    # 识别孤立设备和受影响路径
    for component in components:
        if len(component) == 1:
            isolated_devices.extend(component)
    
    return {
        "failed_device": failed_device_id,
        "isolated_devices": isolated_devices,
        "affected_components": len(components),
        "impact_level": calculate_impact_level(isolated_devices),
        "recovery_suggestions": generate_recovery_plan(failed_device_id)
    }
```

## 6. 用户界面设计

### 6.1 整体布局
```
┌─────────────────────────────────────────────────────────────┐
│                        工具栏                               │
├─────────────────────────────────────────────────────────────┤
│                    │                                        │
│                    │                                        │
│    控制面板        │            拓扑图主视图                │
│                    │                                        │
│  • 设备选择器      │                                        │
│  • 筛选器          │                                        │
│  • 布局控制        │                                        │
│  • 视图模式        │                                        │
│                    │                                        │
├─────────────────────────────────────────────────────────────┤
│                      信息面板                               │
│              显示选中节点/边的详细信息                      │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 工具栏功能
- **设备选择器**：快速定位和选择中心设备
- **布局切换**：层级布局 / 力导向布局 / 圆形布局
- **筛选器**：按设备类型、连接类型、状态等筛选
- **视图模式**：全网视图 / 局部视图 / 路径视图
- **导出功能**：PNG / SVG / PDF 格式导出
- **全屏模式**：最大化拓扑图显示区域

### 6.3 交互功能
- **节点交互**：
  - 单击：选中并显示详细信息
  - 双击：以该节点为中心重新构建拓扑
  - 右键：显示上下文菜单（查看详情、路径分析等）
  - 拖拽：调整节点位置
  - 悬停：显示基本信息提示

- **边交互**：
  - 单击：选中并显示连接详情
  - 悬停：显示连接参数
  - 右键：编辑连接信息

- **画布交互**：
  - 缩放：鼠标滚轮或手势缩放
  - 平移：拖拽画布移动视图
  - 框选：选择多个节点进行批量操作
  - 搜索：快速定位指定设备

## 7. 可视化设计规范

### 7.1 连接线颜色标准

#### 7.1.1 电力行业标准对应
为了与现实中的电缆颜色标准保持一致，系统采用以下颜色方案：

**交流电缆颜色标准**：
- **三相交流电缆**：采用黄绿红三色渐变或分段显示
  - 黄色（#FFEB3B）：A相
  - 绿色（#4CAF50）：B相  
  - 红色（#F44336）：C相
- **单相交流电缆**：蓝色（#2196F3）

**直流电缆颜色标准**：
- **正极**：红色（#F44336）
- **负极**：蓝色（#2196F3）
- **双线显示**：红蓝并行线或红蓝渐变

**其他连接类型**：
- **铜排**：橙色（#FF9800）粗线
- **母线**：绿色（#4CAF50）双线
- **光纤**：紫色（#9C27B0）虚线

#### 7.1.2 数据兼容性设计
考虑到现有数据可能不完整，设计采用以下兼容策略：

**数据字段映射**：
```json
{
  "power_type": "AC|DC",  // 电源类型，默认DC
  "cable_type": "电缆|铜排|母线",  // 连接类型
  "specification": "YJV-4×95",  // 线缆规格
  "rated_current": 200,  // 额定电流（可选）
  "parallel_count": 1  // 并联数量（可选，默认1）
}
```

**默认处理规则**：
- 缺少power_type时，默认为DC（直流）- 考虑到通信电源系统以直流为主
- 缺少rated_current时，线条使用标准粗细
- 缺少specification时，不显示规格标注
- 根据cable_type自动选择对应颜色方案

### 7.2 节点设计

#### 7.2.1 设备类型区分
系统支持以下主要设备类型，每种设备都有对应的图标和颜色方案：

**电源设备类**：
- **UPS**：绿色矩形，UPS图标
- **变压器**：紫色矩形，变压器图标
- **直流操作屏**：蓝色矩形，操作屏图标

**配电设备类**：
- **高压配电柜**：红色矩形，高压配电图标
- **低压配电柜**：橙色矩形，低压配电图标
- **直流分配柜**：青色矩形，直流分配图标
- **ATS柜（双路电源自动切换）**：黄色矩形，ATS图标

**其他设备类**：
- **服务器**：灰色矩形，服务器图标
- **网络设备**：深蓝色矩形，网络图标

#### 7.2.2 图标定制化方案
为了提高系统的灵活性和用户体验，设计采用图标定制化方案：

**图标目录结构**：
```
static/
├── device_icons/
│   ├── ups.svg
│   ├── transformer.svg
│   ├── high_voltage_cabinet.svg
│   ├── low_voltage_cabinet.svg
│   ├── ats_cabinet.svg
│   ├── dc_distribution_cabinet.svg
│   ├── dc_operation_panel.svg
│   ├── server.svg
│   └── network_device.svg
└── default_icons/
    └── unknown_device.svg
```

**图标规范**：
- 格式：SVG矢量格式，支持缩放不失真
- 尺寸：建议32x32px基准尺寸
- 颜色：单色或简单配色，便于主题适配
- 命名：使用设备类型的英文名称，小写加下划线

**定制化使用方式**：
1. 用户将自定义图标文件放入`static/device_icons/`目录
2. 图标文件名需与设备类型对应
3. 系统自动加载并应用新图标
4. 如果找不到对应图标，使用默认图标

#### 7.2.3 简化设计原则
基于资产管理的核心需求，节点设计遵循以下简化原则：

- **专注可视化呈现**：重点展示设备类型、位置和连接关系
- **避免状态复杂化**：不显示设备运行状态（正常/故障等）
- **统一视觉风格**：所有设备使用统一的尺寸和样式
- **易于识别**：通过图标和颜色快速识别设备类型
- **用户可定制**：支持图标的灵活替换和定制

### 7.3 连接线视觉实现

#### 7.3.1 vis.js配置示例
```javascript
// 根据连接类型和电源类型确定边的样式
function getEdgeStyle(connection) {
  const { cable_type, power_type, rated_current } = connection.properties;
  
  let color, width = 2;
  
  // 根据额定电流调整线条粗细
  if (rated_current) {
    width = Math.max(1, Math.min(8, rated_current / 50));
  }
  
  // 根据连接类型和电源类型确定颜色
   // 默认为直流系统（通信电源系统以直流为主）
   const powerType = power_type || 'DC';
   
   switch (cable_type) {
     case '电缆':
       if (powerType === 'DC') {
         color = { color: '#F44336', highlight: '#D32F2F' }; // 直流红色
       } else {
         // 交流三相渐变色
         color = { 
           color: '#FFEB3B', 
           highlight: '#FBC02D',
           opacity: 0.8
         };
       }
       break;
    case '铜排':
      color = { color: '#FF9800', highlight: '#F57C00' };
      width += 2; // 铜排更粗
      break;
    case '母线':
      color = { color: '#4CAF50', highlight: '#388E3C' };
      width += 1;
      break;
    default:
      color = { color: '#9E9E9E', highlight: '#757575' };
  }
  
  return { color, width };
}
```

#### 7.3.2 设计原则
- **专注资源管理**：不涉及运行状态监控，专注于设备和连接的静态信息
- **数据兼容性**：兼容现有数据结构，不依赖可能缺失的负载数据
- **视觉清晰**：避免过度复杂的状态表示，保持界面简洁易读
- **行业标准**：遵循电力行业的颜色标准，提高专业性

### 7.4 布局算法
- **层级布局**：适用于展示上下游关系
  - 电源设备在上层
  - 负载设备在下层
  - 中间设备按层级排列

- **力导向布局**：适用于复杂网络结构
  - 相关设备自然聚集
  - 重要设备居中显示
  - 边长反映关系强度

- **圆形布局**：适用于环形网络
  - 设备沿圆周分布
  - 中心显示关键信息
  - 便于观察对称性

### 7.5 交互功能
- **节点交互**：
  - 点击显示设备详细信息
  - 双击跳转到设备管理页面
  - 右键菜单提供快捷操作
  - 拖拽调整节点位置

- **边交互**：
  - 悬停显示连接详情
  - 点击高亮连接路径
  - 右键查看连接属性
  - 支持连接编辑功能

- **视图控制**：
  - 缩放和平移操作
  - 全屏显示模式
  - 视图重置功能
  - 适应窗口大小

- **搜索和筛选**：
  - 设备名称快速搜索
  - 按设备类型筛选
  - 按连接类型筛选
  - 路径高亮显示

## 8. 高级功能设计

### 8.1 智能分析功能
- **路径分析**：
  - 最短路径计算
  - 冗余路径识别
  - 关键路径分析
  - 瓶颈点检测

- **影响分析**：
  - 断电影响范围预测
  - 设备依赖关系分析
  - 替代路径识别
  - 应急预案推荐

- **容量分析**：
  - 电力容量分布可视化
  - 容量瓶颈识别
  - 扩容建议
  - 容量规划支持

- **优化建议**：
  - 网络结构优化
  - 冗余度改进
  - 成本效益分析
  - 扩容方案推荐

### 8.2 实时监控功能
- **资源监控**：
  - 设备配置信息更新
  - 连接关系变更追踪
  - 容量配置动态展示
  - 历史变更分析

- **变更追踪**：
  - 拓扑结构变更记录
  - 配置修改历史
  - 操作日志审计
  - 版本对比分析

### 8.3 协作功能
- **标注功能**：
  - 节点和边的文字标注
  - 图形标记和高亮
  - 维护计划标识
  - 问题点标记

- **分享功能**：
  - 视图快照保存
  - 链接分享
  - 报告生成
  - 打印输出

## 9. 性能优化策略

### 9.1 前端优化
- **渲染优化**：
  - 虚拟化渲染，只显示可视区域
  - LOD（细节层次）技术，远距离简化显示
  - Canvas/WebGL加速渲染
  - 节点和边的对象池管理

- **交互优化**：
  - 防抖和节流技术
  - 异步数据加载
  - 增量更新机制
  - 智能缓存策略

- **内存管理**：
  - 懒加载机制
  - 定期垃圾回收
  - 大图分块加载
  - 内存使用监控

### 9.2 后端优化
- **算法优化**：
  - 图算法并行化
  - 预计算常用拓扑
  - 索引优化
  - 查询缓存

- **数据传输优化**：
  - 数据压缩
  - 增量传输
  - WebSocket长连接
  - CDN加速

- **存储优化**：
  - 图数据库应用
  - 分布式存储
  - 读写分离
  - 数据分片

### 9.3 扩展性设计
- **模块化架构**：
  - 插件式功能扩展
  - 主题和样式定制
  - API标准化
  - 配置外部化

- **多租户支持**：
  - 数据隔离
  - 权限控制
  - 资源配额
  - 个性化配置

## 10. 实施计划

### 10.1 第一阶段：基础功能完善（2-3周）
- **目标**：完善现有拓扑图功能，提供稳定的基础体验
- **任务**：
  - 整合独立页面和标签页功能
  - 优化节点和边的视觉设计
  - 实现基础交互功能
  - 添加工具栏和控制面板
  - 完善API数据结构

### 10.2 第二阶段：交互和分析功能（3-4周）
- **目标**：增加高级交互功能和基础分析能力
- **任务**：
  - 实现多种布局算法
  - 添加筛选和搜索功能
  - 开发路径分析功能
  - 实现影响分析算法
  - 添加导出和分享功能

### 10.3 第三阶段：智能功能和优化（4-5周）
- **目标**：实现智能分析和性能优化
- **任务**：
  - 开发负载分析功能
  - 实现实时监控和告警
  - 添加优化建议功能
  - 性能优化和扩展性改进
  - 用户体验优化

### 10.4 第四阶段：测试和部署（1-2周）
- **目标**：全面测试和生产部署
- **任务**：
  - 功能测试和性能测试
  - 用户验收测试
  - 文档编写和培训
  - 生产环境部署
  - 监控和维护

## 11. 风险评估与缓解

### 11.1 技术风险
- **性能风险**：大规模网络渲染可能导致性能问题
  - 缓解措施：分阶段加载、虚拟化渲染、性能监控

- **兼容性风险**：不同浏览器和设备的兼容性问题
  - 缓解措施：广泛测试、渐进增强、降级方案

- **数据一致性风险**：拓扑数据与实际网络不一致
  - 缓解措施：数据验证、定期同步、异常检测

### 11.2 业务风险
- **用户接受度风险**：新功能可能不符合用户习惯
  - 缓解措施：用户调研、原型验证、渐进式发布

- **维护成本风险**：复杂功能可能增加维护难度
  - 缓解措施：模块化设计、文档完善、代码规范

## 12. 成功关键因素

### 12.1 技术因素
- 选择合适的可视化技术和算法
- 实现高效的性能优化策略
- 保证系统的稳定性和可扩展性

### 12.2 用户体验因素
- 直观易用的界面设计
- 流畅的交互体验
- 丰富的功能和灵活的定制

### 12.3 项目管理因素
- 合理的进度安排和资源配置
- 有效的沟通和协作机制
- 持续的测试和质量保证

## 13. 总结

本设计方案基于对现有系统的深入分析，结合动力设备管理的实际需求，提出了一个全面的拓扑图设计和实施方案。该方案不仅解决了当前系统的问题，还为未来的功能扩展奠定了基础。

通过分阶段实施，可以在保证系统稳定性的前提下，逐步提升拓扑图的功能和用户体验。最终实现一个专业级的动力设备拓扑分析工具，为运维人员提供强大的决策支持。

该设计方案具有以下特点：
- **全面性**：覆盖了从基础展示到智能分析的完整功能
- **实用性**：基于实际业务需求，提供有价值的功能
- **可行性**：基于现有技术栈，实施风险可控
- **扩展性**：模块化设计，便于未来功能扩展
- **专业性**：符合电力行业的专业要求和标准

通过这个设计方案的实施，将大大提升动力设备管理系统的专业性和实用性，为用户提供更好的使用体验和决策支持。